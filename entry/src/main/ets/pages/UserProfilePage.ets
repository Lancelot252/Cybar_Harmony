// UserProfilePage.ets - ç”¨æˆ·ä¸­å¿ƒé¡µé¢
// å¯¹åº” Swift é¡¹ç›®ä¸­çš„ UserProfileView

import APIService from '../services/APIService';
import { LoginPage } from './LoginPage';
import { RegisterPage } from './RegisterPage';
import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';

@Component
export struct UserProfilePage {
  // ä»Žå¤–éƒ¨ä¼ å…¥çš„åˆ·æ–°è§¦å‘å™¨
  @Prop @Watch('onRefreshTriggerChange') refreshTrigger: number = 0;
  
  @State isLoggedIn: boolean = false;
  @State userName: string = 'æœªç™»å½•';
  @State userRole: string = '';
  @State showLogin: boolean = false;
  @State showRegister: boolean = false;
  
  // æ•°æ®çŠ¶æ€
  @State favoritesCount: number = 0;
  @State myRecipesCount: number = 0;
  @State totalLikes: number = 0;
  @State loadingFavorites: boolean = false;
  @State loadingMyRecipes: boolean = false;
  @State favoritesError: string = '';
  @State myRecipesError: string = '';
  @State loginStatusDebug: string = '';
  
  // åˆ·æ–°è§¦å‘å™¨å˜åŒ–æ—¶åˆ·æ–°æ•°æ®
  onRefreshTriggerChange() {
    console.info('[UserProfilePage] refreshTrigger changed, refreshing...');
    if (this.isLoggedIn) {
      this.refreshAll();
    }
  }
  
  // çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
  private stateChangeListener = () => {
    this.updateFromAPIService();
  }
  
  // ä»Ž APIService æ›´æ–°æœ¬åœ°çŠ¶æ€
  private updateFromAPIService() {
    const apiService = APIService.getInstance();
    const wasLoggedIn = this.isLoggedIn;
    this.isLoggedIn = apiService.isLoggedIn;
    
    if (apiService.currentUser) {
      this.userName = apiService.currentUser.username;
      this.userRole = apiService.currentUser.role;
    } else {
      this.userName = 'æœªç™»å½•';
      this.userRole = '';
    }
    const cacheInfo = apiService.cachedLogin;
    
    // å¦‚æžœä»Žæœªç™»å½•å˜ä¸ºå·²ç™»å½•,åˆ·æ–°æ•°æ®
    if (!wasLoggedIn && this.isLoggedIn) {
      this.refreshAll();
    }
    
    // å¦‚æžœä»Žå·²ç™»å½•å˜ä¸ºæœªç™»å½•,æ¸…ç©ºæ•°æ®
    if (wasLoggedIn && !this.isLoggedIn) {
      this.clearData();
    }

    const timestamp = new Date().toLocaleString();
    const cacheLabel = cacheInfo ? `${cacheInfo.username}/${cacheInfo.role || 'è§’è‰²æœªçŸ¥'}` : 'æ— ç¼“å­˜';
    const cacheAge = cacheInfo ? `${Math.floor((Date.now() - cacheInfo.cachedAt) / (60 * 1000))}åˆ†é’Ÿ` : 'N/A';
    // this.loginStatusDebug = `${timestamp}ï½œå‰çŠ¶æ€ ${wasLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'} â†’ å½“å‰ ${this.isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}ï½œç¼“å­˜ ${cacheLabel}ï½œç¼“å­˜é¾„ ${cacheAge}`;
  }
  
  // åˆ·æ–°æ‰€æœ‰æ•°æ®
  private refreshAll() {
    this.totalLikes = 0;
    this.loadFavorites();
    this.loadMyRecipes();
  }
  
  // æ¸…ç©ºæ•°æ®
  private clearData() {
    this.favoritesCount = 0;
    this.myRecipesCount = 0;
    this.totalLikes = 0;
    this.favoritesError = '';
    this.myRecipesError = '';
  }
  
  // åŠ è½½æ”¶è—åˆ—è¡¨
  private async loadFavorites() {
    this.loadingFavorites = true;
    this.favoritesError = '';
    
    try {
      const favorites = await APIService.getInstance().fetchUserFavorites();
      this.favoritesCount = Array.isArray(favorites) ? favorites.length : 0;
    } catch (error) {
      this.favoritesError = error instanceof Error ? error.message : 'åŠ è½½å¤±è´¥';
    } finally {
      this.loadingFavorites = false;
    }
  }
  
  // åŠ è½½æˆ‘çš„é…æ–¹
  private async loadMyRecipes() {
    this.loadingMyRecipes = true;
    this.myRecipesError = '';
    
    try {
      const apiService = APIService.getInstance();
      const recipes = await apiService.fetchUserCreatedRecipes();
      this.myRecipesCount = Array.isArray(recipes) ? recipes.length : 0;
      
      // è®¡ç®—æ€»ç‚¹èµžæ•°
      if (Array.isArray(recipes) && recipes.length > 0) {
        // å…ˆå°è¯•ä»Žè¿”å›žæ•°æ®ä¸­èŽ·å–
        const initialLikes = recipes.reduce((sum: number, recipe: ESObject) => {
          const likeCount = recipe['likeCount'] as number || recipe['like_count'] as number || 0;
          return sum + likeCount;
        }, 0);
        
        this.totalLikes = initialLikes;
        
        // å¦‚æžœæ‰€æœ‰é…æ–¹çš„ç‚¹èµžæ•°éƒ½æ˜¯0,å¯èƒ½æ˜¯æœåŠ¡å™¨æ²¡æœ‰è¿”å›ž,éœ€è¦è¡¥å……
        if (initialLikes === 0) {
          console.info('[UserProfilePage] è¡¥å……é…æ–¹ç‚¹èµžæ•°ç»Ÿè®¡...');
          let totalLikes = 0;
          
          // æ‰¹é‡èŽ·å–æ¯ä¸ªé…æ–¹çš„è¯¦æƒ…
          const promises = recipes.map(async (recipe: ESObject) => {
            try {
              const recipeId = recipe['id'] as string;
              const detail = await apiService.fetchRecipeDetail(recipeId);
              const likeCount = detail['likeCount'] as number || detail['like_count'] as number || 0;
              return likeCount;
            } catch (error) {
              console.warn('[UserProfilePage] èŽ·å–é…æ–¹ç‚¹èµžæ•°å¤±è´¥:', error);
              return 0;
            }
          });
          
          const likeCounts = await Promise.all(promises);
          totalLikes = likeCounts.reduce((sum, count) => sum + count, 0);
          this.totalLikes = totalLikes;
          console.info(`[UserProfilePage] è¡¥å……å®Œæˆ, æ€»ç‚¹èµžæ•°: ${totalLikes}`);
        }
      } else {
        this.totalLikes = 0;
      }
    } catch (error) {
      this.myRecipesError = error instanceof Error ? error.message : 'åŠ è½½å¤±è´¥';
      this.totalLikes = 0;
    } finally {
      this.loadingMyRecipes = false;
    }
  }
  
  // ç™»å‡º
  private async handleLogout() {
    try {
      await APIService.getInstance().logout();
      promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
    } catch (error) {
      promptAction.showToast({ message: 'é€€å‡ºç™»å½•å¤±è´¥' });
    }
  }
  
  aboutToAppear() {
    // åˆå§‹åŒ–æ—¶æ›´æ–°çŠ¶æ€
    this.updateFromAPIService();
    
    // æ³¨å†Œç›‘å¬å™¨
    APIService.getInstance().addListener(this.stateChangeListener);
    
    // å¦‚æžœå·²ç™»å½•,åŠ è½½æ•°æ®
    if (this.isLoggedIn) {
      this.refreshAll();
    }
  }
  
  aboutToDisappear() {
    // ç§»é™¤ç›‘å¬å™¨
    APIService.getInstance().removeListener(this.stateChangeListener);
  }
  
  // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®ï¼ˆä»Žå…¶ä»–é¡µé¢è¿”å›žæ—¶ä¹Ÿä¼šè§¦å‘ï¼‰
  onPageShow() {
    console.info('[UserProfilePage] onPageShow triggered');
    if (this.isLoggedIn) {
      this.refreshAll();
    }
  }
  
  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('æˆ‘çš„')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.Center)
        
        if (this.isLoggedIn) {
          // å·²ç™»å½•çŠ¶æ€
          this.buildLoggedInView();
        } else {
          // æœªç™»å½•çŠ¶æ€
          this.buildLoginPromptView();
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
      
      // ç™»å½•å¼¹çª—
      if (this.showLogin) {
        Column() {
          LoginPage({
            onSuccess: () => {
              this.showLogin = false;
              // çŠ¶æ€ä¼šé€šè¿‡ç›‘å¬å™¨è‡ªåŠ¨æ›´æ–°
            },
            onCancel: () => {
              this.showLogin = false;
            }
          })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#FFFFFF')
        .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 1000 } })
        .transition({ type: TransitionType.Delete, opacity: 0, translate: { y: 1000 } })
      }
      
      // æ³¨å†Œå¼¹çª—
      if (this.showRegister) {
        Column() {
          RegisterPage({
            onSuccess: () => {
              this.showRegister = false;
              // çŠ¶æ€ä¼šé€šè¿‡ç›‘å¬å™¨è‡ªåŠ¨æ›´æ–°
            },
            onCancel: () => {
              this.showRegister = false;
            }
          })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#FFFFFF')
        .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 1000 } })
        .transition({ type: TransitionType.Delete, opacity: 0, translate: { y: 1000 } })
      }
    }
    .width('100%')
    .height('100%')
  }
  
  // æœªç™»å½•è§†å›¾
  @Builder
  buildLoginPromptView() {
    Column() {
      Blank()
      
      Column({ space: 20 }) {
        // å›¾æ ‡
        Text('ðŸ‘¤')
          .fontSize(80)
        
        // æç¤ºæ–‡å­—
        Text('ç™»å½•ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
        
        Text('ç™»å½•åŽå¯ä»¥æ”¶è—é…æ–¹ã€åˆ›å»ºé…æ–¹ç­‰')
          .fontSize(14)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)
          .padding({ left: 32, right: 32 })

        Text(this.loginStatusDebug)
          .fontSize(12)
          .fontColor('#BBBBBB')
          .textAlign(TextAlign.Center)
          .padding({ left: 32, right: 32 })
        
        // ç™»å½•æ³¨å†ŒæŒ‰é’®
        Column({ space: 12 }) {
          Button('ç™»å½•')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .backgroundColor('#007DFF')
            .borderRadius(12)
            .onClick(() => {
              this.showLogin = true;
            })
          
          Button('æ³¨å†Œæ–°è´¦å·')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .backgroundColor('rgba(0, 125, 255, 0.1)')
            .fontColor('#007DFF')
            .borderRadius(12)
            .onClick(() => {
              this.showRegister = true;
            })
        }
        .width('100%')
        .padding({ left: 40, right: 40 })
      }
      .width('100%')
      
      Blank()
    }
    .layoutWeight(1)
    .width('100%')
  }
  
  // å·²ç™»å½•è§†å›¾
  @Builder
  buildLoggedInView() {
    Scroll() {
      Column({ space: 24 }) {
        // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
        Column({ space: 10 }) {
          Text('ðŸ‘¤')
            .fontSize(90)
          
          Text(this.userName)
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
          
          Text(`æ€»ç‚¹èµžæ•°: ${this.totalLikes}`)
            .fontSize(14)
            .fontColor('#999999')
          
          if (this.userRole === 'admin') {
            Text('ç®¡ç†å‘˜')
              .fontSize(12)
              .fontColor('#FF3B30')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('rgba(255, 59, 48, 0.15)')
              .borderRadius(6)
          }

          Text(this.loginStatusDebug)
            .fontSize(12)
            .fontColor('#BBBBBB')
            .textAlign(TextAlign.Center)
            .padding({ top: 4 })
        }
        .width('100%')
        .padding({ top: 20, bottom: 20 })
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .shadow({ radius: 5, color: 'rgba(0, 0, 0, 0.05)', offsetY: 2 })
        
        // ç»Ÿè®¡å¡ç‰‡
        Row({ space: 16 }) {
          // æˆ‘çš„é…æ–¹
          Column({ space: 8 }) {
            Text('ðŸ“')
              .fontSize(32)
            
            Text('æˆ‘çš„é…æ–¹')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
            
            Text(`${this.myRecipesCount} ä¸ª`)
              .fontSize(14)
              .fontColor('#999999')
          }
          .layoutWeight(1)
          .padding(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .shadow({ radius: 4, color: 'rgba(0, 0, 0, 0.04)', offsetY: 2 })
          .onClick(() => {
            router.pushUrl({
              url: '@bundle:com.example.cybar/entry/ets/pages/MyRecipesPage'
            }).catch((error: Error) => {
              console.error('[UserProfilePage] è·³è½¬æˆ‘çš„é…æ–¹é¡µé¢å¤±è´¥:', error);
              promptAction.showToast({ message: 'è·³è½¬å¤±è´¥' });
            });
          })
          
          // æˆ‘çš„æ”¶è—
          Column({ space: 8 }) {
            Text('â­')
              .fontSize(32)
            
            Text('æˆ‘çš„æ”¶è—')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
            
            Text(`${this.favoritesCount} ä¸ª`)
              .fontSize(14)
              .fontColor('#999999')
          }
          .layoutWeight(1)
          .padding(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .shadow({ radius: 4, color: 'rgba(0, 0, 0, 0.04)', offsetY: 2 })
          .onClick(() => {
            router.pushUrl({
              url: '@bundle:com.example.cybar/entry/ets/pages/MyFavoritesPage'
            }).catch((error: Error) => {
              console.error('[UserProfilePage] è·³è½¬æˆ‘çš„æ”¶è—é¡µé¢å¤±è´¥:', error);
              promptAction.showToast({ message: 'è·³è½¬å¤±è´¥' });
            });
          })
        }
        .width('100%')
        
        // è®¾ç½®å¡ç‰‡
        Column({ space: 18 }) {
          // ç®¡ç†å‘˜é¢æ¿(ä»…ç®¡ç†å‘˜å¯è§)
          if (this.userRole === 'admin') {
            Row() {
              Text('âš™ï¸')
                .fontSize(24)
                .margin({ right: 12 })
              
              Column({ space: 6 }) {
                Text('ç®¡ç†å‘˜é¢æ¿')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .alignSelf(ItemAlign.Start)
                
                Text('ç®¡ç†ç”¨æˆ·å’Œé…æ–¹')
                  .fontSize(12)
                  .fontColor('#999999')
                  .alignSelf(ItemAlign.Start)
              }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            
            Text('â€º')
              .fontSize(20)
              .fontColor('#999999')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .padding(18)
          .onClick(() => {
            promptAction.showToast({ message: 'åŠŸèƒ½å¼€å‘ä¸­...' });
          })
          
          Divider()
            .color('#F0F0F0')
        }          // è®¾ç½®
          Row() {
            Text('âš™ï¸')
              .fontSize(24)
              .margin({ right: 12 })
            
            Column({ space: 6 }) {
              Text('è®¾ç½®')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
              
              Text('åº”ç”¨è®¾ç½®å’Œåå¥½')
                .fontSize(12)
                .fontColor('#999999')
                .alignSelf(ItemAlign.Start)
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            
            Text('â€º')
              .fontSize(20)
              .fontColor('#999999')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .padding(18)
          .onClick(() => {
            router.pushUrl({
              url: '@bundle:com.example.cybar/entry/ets/pages/SettingsPage'
            }).catch((error: Error) => {
              console.error('[UserProfilePage] è·³è½¬è®¾ç½®é¡µé¢å¤±è´¥:', error);
              promptAction.showToast({ message: 'è·³è½¬å¤±è´¥' });
            });
          })
          
          Divider()
            .color('#F0F0F0')
          
          // é€€å‡ºç™»å½•
          Row() {
            Text('ðŸšª')
              .fontSize(24)
              .margin({ right: 12 })
            
            Text('é€€å‡ºç™»å½•')
              .fontSize(16)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Medium)
            
            Blank()
          }
          .width('100%')
          .padding(18)
          .onClick(() => {
            this.handleLogout();
          })
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .shadow({ radius: 4, color: 'rgba(0, 0, 0, 0.04)', offsetY: 2 })
      }
      .width('100%')
      .padding(16)
    }
    .layoutWeight(1)
    .width('100%')
  }
}
