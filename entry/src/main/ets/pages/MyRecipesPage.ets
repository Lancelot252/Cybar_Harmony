// MyRecipesPage.ets - æˆ‘çš„é…æ–¹é¡µé¢
// å‚è€ƒ Swift é¡¹ç›®ä¸­çš„ MyRecipesFullScreen

import { router } from '@kit.ArkUI';
import APIService from '../services/APIService';
import { Recipe } from '../models/Recipe';
import promptAction from '@ohos.promptAction';

@Entry
@Component
export struct MyRecipesPage {
  @State recipes: Array<Recipe> = [];
  @State isLoading: boolean = false;
  @State hasError: boolean = false;
  @State errorMessage: string = '';
  @State totalLikes: number = 0;
  
  aboutToAppear() {
    this.loadMyRecipes();
  }
  
  /**
   * åŠ è½½æˆ‘çš„é…æ–¹
   */
  private async loadMyRecipes() {
    this.isLoading = true;
    this.hasError = false;
    this.errorMessage = '';
    
    try {
      console.info('[MyRecipesPage] Loading my recipes...');
      const apiService = APIService.getInstance();
      const data = await apiService.fetchUserCreatedRecipes();
      
      if (Array.isArray(data)) {
        console.info(`[MyRecipesPage] æ”¶åˆ°æ•°æ®æ•°ç»„, é•¿åº¦: ${data.length}`);
        if (data.length > 0) {
          console.info(`[MyRecipesPage] ç¬¬ä¸€æ¡æ•°æ®æ ·ä¾‹:`, JSON.stringify(data[0]));
        }
        
        // å…ˆåˆ›å»ºåŸºç¡€é…æ–¹æ•°æ®
        this.recipes = data.map((item: ESObject): Recipe => {
          return {
            id: (item['id'] || '') as string,
            name: (item['name'] || 'æœªå‘½å') as string,
            createdBy: (item['createdBy'] || item['created_by'] || 'æœªçŸ¥') as string,
            instructions: (item['instructions'] || '') as string,
            estimatedAbv: this.parseNumber(item['estimatedAbv'] || item['estimated_abv']),
            likeCount: this.parseNumber(item['likeCount'] || item['like_count']),
            favoriteCount: this.parseNumber(item['favoriteCount'] || item['favorite_count']),
            ingredients: (item['ingredients'] || '') as string
          };
        });
        
        console.info(`[MyRecipesPage] æˆåŠŸè§£æ ${this.recipes.length} ä¸ªé…æ–¹`);
        
        // å¦‚æœæ•°æ®ç¼ºå°‘ç»Ÿè®¡ä¿¡æ¯,æ‰¹é‡è¡¥å……
        await this.enrichRecipesWithStats();
        
        // è®¡ç®—æ€»ç‚¹èµæ•°
        this.totalLikes = this.recipes.reduce((sum: number, recipe: Recipe) => {
          return sum + recipe.likeCount;
        }, 0);
        
        console.info(`[MyRecipesPage] ç»Ÿè®¡å®Œæˆ - æ€»ç‚¹èµ: ${this.totalLikes}`);
      } else {
        console.warn('[MyRecipesPage] æ•°æ®ä¸æ˜¯æ•°ç»„æ ¼å¼');
        this.recipes = [];
        this.totalLikes = 0;
      }
    } catch (error) {
      console.error('[MyRecipesPage] Load failed:', error);
      this.hasError = true;
      this.errorMessage = error instanceof Error ? error.message : 'åŠ è½½å¤±è´¥';
    } finally {
      this.isLoading = false;
    }
  }
  
  /**
   * è¡¥å……é…æ–¹çš„ç»Ÿè®¡ä¿¡æ¯(ç‚¹èµæ•°å’Œæ”¶è—æ•°)
   */
  private async enrichRecipesWithStats() {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å……ç»Ÿè®¡ä¿¡æ¯
    const needsEnrichment = this.recipes.some(r => r.likeCount === 0 && r.favoriteCount === 0);
    if (!needsEnrichment || this.recipes.length === 0) {
      console.info('[MyRecipesPage] æ— éœ€è¡¥å……ç»Ÿè®¡ä¿¡æ¯');
      return;
    }
    
    console.info('[MyRecipesPage] å¼€å§‹è¡¥å……ç»Ÿè®¡ä¿¡æ¯...');
    const apiService = APIService.getInstance();
    
    // æ‰¹é‡è·å–é…æ–¹è¯¦æƒ…
    const promises = this.recipes.map(async (recipe: Recipe, index: number) => {
      try {
        const detail = await apiService.fetchRecipeDetail(recipe.id);
        if (detail) {
          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          this.recipes[index].likeCount = this.parseNumber(detail['likeCount'] || detail['like_count']);
          this.recipes[index].favoriteCount = this.parseNumber(detail['favoriteCount'] || detail['favorite_count']);
        }
      } catch (error) {
        console.warn(`[MyRecipesPage] è·å–é…æ–¹ ${recipe.id} ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:`, error);
      }
    });
    
    await Promise.all(promises);
    console.info('[MyRecipesPage] ç»Ÿè®¡ä¿¡æ¯è¡¥å……å®Œæˆ');
  }
  
  /**
   * å®‰å…¨åœ°è§£ææ•°å€¼
   */
  private parseNumber(value: ESObject): number {
    if (value === null || value === undefined) {
      return 0;
    }
    if (typeof value === 'number') {
      return value;
    }
    if (typeof value === 'string') {
      const parsed = parseFloat(value as string);
      return isNaN(parsed) ? 0 : parsed;
    }
    const parsed = parseFloat(String(value));
    return isNaN(parsed) ? 0 : parsed;
  }
  
  /**
   * è·³è½¬åˆ°é…æ–¹è¯¦æƒ…
   */
  private navigateToDetail(recipe: Recipe) {
    router.pushUrl({
      url: '@bundle:com.example.cybar/entry/ets/pages/RecipeDetailPage',
      params: {
        recipeId: recipe.id
      }
    }).catch((error: Error) => {
      console.error('[MyRecipesPage] Navigation failed:', error);
      promptAction.showToast({ message: 'è·³è½¬å¤±è´¥' });
    });
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Row({ space: 4 }) {
            Text('â†')
              .fontSize(24)
              .fontColor('#007DFF')
            Text('è¿”å›')
              .fontSize(16)
              .fontColor('#007DFF')
          }
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .height(44)
        .padding({ left: 4, right: 12 })
        .onClick(() => {
          router.back();
        })
        
        Text('æˆ‘çš„é…æ–¹')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // åˆ·æ–°æŒ‰é’®
        Button() {
          Text('ğŸ”„')
            .fontSize(20)
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(44)
        .height(44)
        .onClick(() => {
          this.loadMyRecipes();
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 8, right: 8 })
      .backgroundColor(Color.White)
      
      // å†…å®¹åŒºåŸŸ
      if (this.hasError) {
        this.buildErrorState();
      } else if (this.isLoading) {
        this.buildLoadingState();
      } else if (this.recipes.length === 0) {
        this.buildEmptyState();
      } else {
        this.buildRecipesList();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  
  /**
   * åŠ è½½çŠ¶æ€
   */
  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#1890ff')
      
      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }
  
  /**
   * é”™è¯¯çŠ¶æ€
   */
  @Builder
  buildErrorState() {
    Column({ space: 16 }) {
      Text('âš ï¸')
        .fontSize(64)
        .opacity(0.3)
      
      Text(this.errorMessage || 'åŠ è½½å¤±è´¥')
        .fontSize(16)
        .fontColor('#FF3B30')
        .textAlign(TextAlign.Center)
      
      Button('é‡è¯•')
        .fontSize(14)
        .backgroundColor('#1890ff')
        .borderRadius(20)
        .padding({ left: 24, right: 24 })
        .margin({ top: 16 })
        .onClick(() => {
          this.loadMyRecipes();
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding(32)
  }
  
  /**
   * ç©ºçŠ¶æ€
   */
  @Builder
  buildEmptyState() {
    Column({ space: 16 }) {
      Text('ğŸ“')
        .fontSize(64)
        .opacity(0.3)
      
      Text('è¿˜æ²¡æœ‰åˆ›å»ºé…æ–¹')
        .fontSize(16)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
      
      Text('å¿«å»åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé¸¡å°¾é…’é…æ–¹å§')
        .fontSize(14)
        .fontColor('#CCCCCC')
        .textAlign(TextAlign.Center)
        .margin({ top: 8 })
      
      Button('åˆ·æ–°')
        .fontSize(14)
        .backgroundColor('#1890ff')
        .borderRadius(20)
        .padding({ left: 24, right: 24 })
        .margin({ top: 16 })
        .onClick(() => {
          this.loadMyRecipes();
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding(32)
  }
  
  /**
   * é…æ–¹åˆ—è¡¨
   */
  @Builder
  buildRecipesList() {
    Scroll() {
      Column() {
        // ç»Ÿè®¡ä¿¡æ¯
        Row({ space: 16 }) {
          Text(`å…± ${this.recipes.length} ä¸ªé…æ–¹`)
            .fontSize(14)
            .fontColor('#666666')
          
          Text(`|`)
            .fontSize(14)
            .fontColor('#DDDDDD')
          
          Text(`æ€»ç‚¹èµ ${this.totalLikes}`)
            .fontSize(14)
            .fontColor('#FF3B30')
            .fontWeight(FontWeight.Medium)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        
        // é…æ–¹ç½‘æ ¼
        GridRow({ columns: 2, gutter: 12 }) {
          ForEach(this.recipes, (recipe: Recipe) => {
            GridCol() {
              this.buildRecipeCard(recipe)
            }
          }, (recipe: Recipe) => recipe.id)
        }
        .padding({ left: 12, right: 12, bottom: 12 })
      }
      .width('100%')
    }
    .layoutWeight(1)
    .width('100%')
    .scrollBar(BarState.Auto)
    .edgeEffect(EdgeEffect.Spring)
  }
  
  /**
   * é…æ–¹å¡ç‰‡
   */
  @Builder
  buildRecipeCard(recipe: Recipe) {
    Column({ space: 12 }) {
      // æ ‡é¢˜å’Œåˆ›å»ºè€…
      Column({ space: 6 }) {
        Text(recipe.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
        
        Text(`ğŸ‘¤ ${recipe.createdBy}`)
          .fontSize(12)
          .fontColor('#666666')
          .width('100%')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // é…’ç²¾åº¦
      Row() {
        Text(`${recipe.estimatedAbv.toFixed(1)}% ABV`)
          .fontSize(12)
          .fontColor('#1890ff')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      
      Divider()
        .color('#F0F0F0')
      
      // äº’åŠ¨ä¿¡æ¯
      Row() {
        Row({ space: 4 }) {
          Text('â¤ï¸')
            .fontSize(14)
          Text(recipe.likeCount.toString())
            .fontSize(11)
            .fontColor('#999999')
        }
        
        Blank()
        
        Row({ space: 4 }) {
          Text('â­')
            .fontSize(14)
          Text(recipe.favoriteCount.toString())
            .fontSize(11)
            .fontColor('#999999')
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.navigateToDetail(recipe);
    })
  }
}
