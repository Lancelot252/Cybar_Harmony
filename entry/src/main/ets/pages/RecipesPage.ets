// RecipesPage.ets - é…æ–¹åˆ—è¡¨é¡µé¢

import { apiService } from '../services/APIService';
import { Recipe, RecipesResponse, Ingredient } from '../models/Recipe';
import { router } from '@kit.ArkUI';
import { ThemeManager, LightTheme, DarkTheme, ThemeColors } from '../common/ThemeManager';

// åˆ†ç±»é…ç½®æ¥å£
interface CategoryConfig {
  id: string;
  name: string;
  keywords: string[]; // ç”¨äºå‰ç«¯è¿‡æ»¤çš„å…³é”®è¯
}

// é…’ç²¾åº¦èŒƒå›´é…ç½®æ¥å£
interface AbvRange {
  id: string;
  name: string;
  min: number;
  max: number;
}

// æ’åºé…ç½®æ¥å£
interface SortOption {
  id: string;
  name: string;
}

interface InteractionUpdatePayload {
  id: string;
  likeCount: number;
  favoriteCount: number;
  isLiked: boolean;
  isFavorited: boolean;
  updatedAt?: number;
}

interface InteractionSnapshot {
  id: string;
  likeCount: number;
  favoriteCount: number;
  isLiked?: boolean;
  isFavorited?: boolean;
}

class BasicDataSource implements IDataSource {
  private listeners: DataChangeListener[] = [];
  private originDataArray: Recipe[] = [];

  public totalCount(): number {
    return this.originDataArray.length;
  }

  public getData(index: number): Recipe {
    return this.originDataArray[index];
  }

  public registerDataChangeListener(listener: DataChangeListener): void {
    if (this.listeners.indexOf(listener) < 0) {
      this.listeners.push(listener);
    }
  }

  public unregisterDataChangeListener(listener: DataChangeListener): void {
    const pos = this.listeners.indexOf(listener);
    if (pos >= 0) {
      this.listeners.splice(pos, 1);
    }
  }

  public notifyDataReload(): void {
    this.listeners.forEach(listener => {
      listener.onDataReloaded();
    })
  }

  public notifyDataAdd(index: number): void {
    this.listeners.forEach(listener => {
      listener.onDataAdd(index);
    })
  }

  public notifyDataChange(index: number): void {
    this.listeners.forEach(listener => {
      listener.onDataChange(index);
    })
  }

  public notifyDataDelete(index: number): void {
    this.listeners.forEach(listener => {
      listener.onDataDelete(index);
    })
  }

  public notifyDataMove(from: number, to: number): void {
    this.listeners.forEach(listener => {
      listener.onDataMove(from, to);
    })
  }

  public setData(data: Recipe[]) {
    this.originDataArray = data;
    this.notifyDataReload();
  }

  public addData(data: Recipe[]) {
    const startIndex = this.originDataArray.length;
    this.originDataArray = this.originDataArray.concat(data);
    data.forEach((_, i) => {
        this.notifyDataAdd(startIndex + i);
    });
  }
}

@Entry
@Component
export struct RecipesPage {
  @State recipesDataSource: BasicDataSource = new BasicDataSource();
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State currentPage: number = 1;
  @State totalPages: number = 1;
  @State errorMessage: string = '';
  @StorageProp('isDarkMode') isDarkMode: boolean = false;
  @StorageLink('recipesRefreshTrigger') @Watch('onRefreshTrigger') refreshTrigger: number = 0;
  @StorageLink('lastRecipeInteraction') @Watch('onInteractionUpdate') interactionUpdate: InteractionUpdatePayload | null = null;
  
  // ç­›é€‰ç›¸å…³çŠ¶æ€
  @State selectedCategory: string = 'all';     // å½“å‰é€‰ä¸­çš„åŸºé…’åˆ†ç±»
  @State selectedAbvRange: string = 'all';     // å½“å‰é€‰ä¸­çš„é…’ç²¾åº¦èŒƒå›´
  @State showFilterPanel: boolean = false;     // æ˜¯å¦æ˜¾ç¤ºç­›é€‰é¢æ¿
  @State allRecipes: Recipe[] = [];            // å­˜å‚¨æ‰€æœ‰é…æ–¹(ç”¨äºå‰ç«¯è¿‡æ»¤)
  @State sortType: string = 'default';
  
  private pageSize: number = 10; 
  private categoryScroller: Scroller = new Scroller();
  
  // åˆ†ç±»é…ç½®
  private categories: CategoryConfig[] = [
    { id: 'all', name: 'å…¨éƒ¨', keywords: [] },
    { id: 'vodka', name: 'ä¼ç‰¹åŠ ', keywords: ['ä¼ç‰¹åŠ ', 'Vodka'] },
    { id: 'rum', name: 'æœ—å§†', keywords: ['æœ—å§†', 'Rum'] },
    { id: 'tequila', name: 'é¾™èˆŒå…°', keywords: ['é¾™èˆŒå…°', 'Tequila'] },
    { id: 'gin', name: 'é‡‘é…’', keywords: ['é‡‘é…’', 'Gin'] },
  ];
  
  // é…’ç²¾åº¦é…ç½®
  private abvRanges: AbvRange[] = [
    { id: 'all', name: 'å…¨éƒ¨', min: 0, max: 100 },
    { id: 'low', name: 'ä½åº¦(0-20%)', min: 0, max: 20 },
    { id: 'medium', name: 'ä¸­åº¦(20-40%)', min: 20, max: 40 },
    { id: 'high', name: 'é«˜åº¦(40%+)', min: 40, max: 100 }
  ];
  
  // æ’åºé…ç½®
  private sortOptions: SortOption[] = [
    { id: 'default', name: 'æœ€æ–°' },
    { id: 'likes', name: 'æœ€çƒ­' },
    { id: 'favorites', name: 'æ”¶è—' },
    { id: 'name', name: 'åç§°' }
  ];
  
  // è·å–å½“å‰ä¸»é¢˜è‰²
  private getColors(): ThemeColors {
    return this.isDarkMode ? DarkTheme : LightTheme;
  }
  
  // åˆ·æ–°è§¦å‘å™¨å›è°ƒ
  onRefreshTrigger() {
    console.info('[RecipesPage] æ£€æµ‹åˆ°åˆ·æ–°è§¦å‘å™¨å˜åŒ–ï¼Œåˆ·æ–°åˆ—è¡¨');
    this.refresh();
  }

  // ç‚¹èµ/æ”¶è—æœ¬åœ°åŒæ­¥
  onInteractionUpdate() {
    if (!this.interactionUpdate) {
      return;
    }
    this.applyInteractionUpdate(this.interactionUpdate as InteractionUpdatePayload);
  }

  aboutToAppear(): void {
    if (this.recipesDataSource.totalCount() === 0) {
      this.fetchRecipes(true);
    }
    // å›åˆ°åˆ—è¡¨æ—¶è‹¥æœ‰æœ€è¿‘äº¤äº’ï¼Œç«‹å³åŒæ­¥æœ¬åœ°æ˜¾ç¤º
    if (this.interactionUpdate) {
      this.applyInteractionUpdate(this.interactionUpdate);
    }
  }

  // é¡µé¢é‡æ–°å¯è§æ—¶ä¹Ÿå¼ºåˆ¶åŒæ­¥ä¸€æ¬¡å¹¶åˆ·æ–°ï¼Œä¿æŒä¸ç”¨æˆ·ä¸­å¿ƒåŒæ ·çš„â€œè¿”å›å³æœ€æ–°â€ä½“éªŒ
  onPageShow(): void {
    if (this.interactionUpdate) {
      this.applyInteractionUpdate(this.interactionUpdate);
    }
    if (!this.isLoading) {
      this.refresh();
    }
  }

  private async fetchRecipes(reset: boolean): Promise<void> {
    if (this.isLoading) return;
    
    if (reset) {
      this.currentPage = 1;
      this.totalPages = 1;
    }
    
    this.isLoading = true;
    this.errorMessage = '';
    
    try {
      const result: RecipesResponse = await apiService.fetchRecipes(
        this.currentPage,
        this.pageSize,
        '',
        this.sortType
      ) as RecipesResponse;
      
      const newRecipes: Array<Recipe> = result.recipes || [];
      console.info('[RecipesPage] è·å–åˆ°çš„é…æ–¹æ•°é‡:', newRecipes.length);
      // è°ƒè¯•ï¼šè¾“å‡ºæœåŠ¡å™¨è¿”å›çš„æ¯ä¸ªé…æ–¹çš„ç‚¹èµ/æ”¶è—æ•°æ®
      const snapshot: InteractionSnapshot[] = newRecipes.map((r: Recipe): InteractionSnapshot => ({
        id: String(r.id),
        likeCount: r.likeCount,
        favoriteCount: r.favoriteCount,
        isLiked: r.isLiked,
        isFavorited: r.isFavorited
      }));
      console.info('[RecipesPage] æœåŠ¡ç«¯äº¤äº’æ•°æ®å¿«ç…§ JSON:', JSON.stringify(snapshot));
      
      // å‰ç«¯è¿›è¡Œåˆ†ç±»å’Œé…’ç²¾åº¦è¿‡æ»¤
      const filteredRecipes = this.filterRecipes(newRecipes);
      console.info('[RecipesPage] è¿‡æ»¤åçš„é…æ–¹æ•°é‡:', filteredRecipes.length);
      
      if (reset) {
        this.recipesDataSource.setData(filteredRecipes);
        this.allRecipes = newRecipes; // ä¿å­˜åŸå§‹æ•°æ®
      } else {
        this.recipesDataSource.addData(filteredRecipes);
        this.allRecipes = this.allRecipes.concat(newRecipes);
      }

      // æ‹‰å–å®ŒæˆååŒæ­¥æœ€è¿‘ä¸€æ¬¡äº¤äº’ï¼Œé˜²æ­¢åç«¯å“åº”æœªå¸¦æœ€æ–°çŠ¶æ€
      if (this.interactionUpdate) {
        this.applyInteractionUpdate(this.interactionUpdate);
      }
      
      this.currentPage = result.currentPage + 1;
      this.totalPages = result.totalPages;
      
    } catch (error) {
      console.error('[RecipesPage] Fetch failed:', error);
      this.errorMessage = 'åŠ è½½å¤±è´¥,è¯·ç¨åé‡è¯•';
    } finally {
      this.isLoading = false;
    }
  }

  private loadMore(): void {
    if (this.currentPage <= this.totalPages && !this.isLoading) {
      this.fetchRecipes(false);
    }
  }

  private refresh(): void {
    this.fetchRecipes(true);
  }

  /**
   * å¤„ç†ä¸‹æ‹‰åˆ·æ–°äº‹ä»¶
   * è¿™ä¸ªæ–¹æ³•åœ¨ç”¨æˆ·å®Œæˆä¸‹æ‹‰åŠ¨ä½œæ—¶è°ƒç”¨
   */
  private async handlePullRefresh(): Promise<void> {
    try {
      console.info('[RecipesPage] å¼€å§‹ä¸‹æ‹‰åˆ·æ–°');
      await this.fetchRecipes(true);
    } catch (error) {
      console.error('[RecipesPage] ä¸‹æ‹‰åˆ·æ–°å¤±è´¥:', error);
    } finally {
      // ä¸‹æ‹‰åˆ·æ–°å®Œæˆåï¼Œè®¾ç½® isRefreshing ä¸º false ä»¥å…³é—­åˆ·æ–°åŠ¨ç”»
      this.isRefreshing = false;
    }
  }
  
  // å‰ç«¯è¿‡æ»¤é€»è¾‘
  private filterRecipes(recipes: Recipe[]): Recipe[] {
    return recipes.filter(recipe => {
      // 1. åŸºé…’åˆ†ç±»è¿‡æ»¤
      if (this.selectedCategory !== 'all') {
        const category = this.categories.find(c => c.id === this.selectedCategory);
        if (category) {
          const ingredients = typeof recipe.ingredients === 'string' 
            ? recipe.ingredients 
            : recipe.ingredients?.map(i => i.name).join(',') || '';
          
          const hasKeyword = category.keywords.some(keyword => 
            ingredients.toLowerCase().includes(keyword.toLowerCase())
          );
          
          if (!hasKeyword) return false;
        }
      }
      
      // 2. é…’ç²¾åº¦è¿‡æ»¤
      if (this.selectedAbvRange !== 'all') {
        const range = this.abvRanges.find(r => r.id === this.selectedAbvRange);
        if (range) {
          if (recipe.estimatedAbv < range.min || recipe.estimatedAbv > range.max) {
            return false;
          }
        }
      }
      
      return true;
    });
  }
  
  // åˆ†ç±»åˆ‡æ¢
  private onCategoryChange(categoryId: string, index: number): void {
    this.selectedCategory = categoryId;
    this.scrollToCategory(index);
    this.applyFilters();
  }
  
  // æ»šåŠ¨åˆ°æŒ‡å®šåˆ†ç±»
  private scrollToCategory(index: number): void {
    try {
      this.categoryScroller.scrollToIndex(index);
    } catch (e) {
      console.error('[RecipesPage] æ»šåŠ¨å¤±è´¥:', e);
    }
  }
  
  // é…’ç²¾åº¦åˆ‡æ¢
  private onAbvRangeChange(rangeId: string): void {
    this.selectedAbvRange = rangeId;
    this.applyFilters();
  }
  
  // æ’åºåˆ‡æ¢
  private onSortChange(sortId: string): void {
    this.sortType = sortId;
    this.fetchRecipes(true);
  }
  
  // åº”ç”¨ç­›é€‰
  private applyFilters(): void {
    const filtered = this.filterRecipes(this.allRecipes);
    this.recipesDataSource.setData(filtered);
  }

  // ä»å­˜å‚¨çš„äº¤äº’äº‹ä»¶åŒæ­¥æœ¬åœ°åˆ—è¡¨
  private applyInteractionUpdate(payload: InteractionUpdatePayload): void {
    try {
      const targetId = String(payload.id || '');
      if (!targetId || this.allRecipes.length === 0) return;

      const likeCount = this.parseNumberSafe(payload.likeCount);
      const favoriteCount = this.parseNumberSafe(payload.favoriteCount);
      const isLiked = payload.isLiked ? true : false;
      const isFavorited = payload.isFavorited ? true : false;

      const updatedAll: Recipe[] = [];
      for (let i = 0; i < this.allRecipes.length; i++) {
        const item: Recipe = this.allRecipes[i];
        const currentId = String(item.id || '');
        if (currentId === targetId) {
          if (likeCount >= 0) {
            item.likeCount = likeCount;
          }
          if (favoriteCount >= 0) {
            item.favoriteCount = favoriteCount;
          }
          item.isLiked = isLiked;
          item.isFavorited = isFavorited;
        }
        updatedAll.push(item);
      }

      this.allRecipes = updatedAll;
      this.applyFilters();
    } catch (e) {
      console.error('[RecipesPage] æœ¬åœ°äº¤äº’åŒæ­¥å¤±è´¥:', e);
    }
  }

  private parseNumberSafe(value: string | number | null | undefined): number {
    if (value === null || value === undefined) {
      return -1;
    }
    if (typeof value === 'number') {
      return value;
    }
    const parsed: number = parseFloat(value);
    return parsed === parsed ? parsed : -1; // NaN è‡ªèº«ä¸ç­‰äºè‡ªèº«
  }
  
  // é‡ç½®ç­›é€‰
  private resetFilters(): void {
    this.selectedCategory = 'all';
    this.selectedAbvRange = 'all';
    this.sortType = 'default';
    this.showFilterPanel = false;
    this.fetchRecipes(true);
  }

  private openRecipeDetail(recipeId: string): void {
    router.pushUrl({
      url: 'pages/RecipeDetailPage',
      params: { recipeId: recipeId }
    });
  }

  @Builder footer(): void {
    Row() {
      if (this.isLoading) {
        LoadingProgress().width(20).height(20).margin({ right: 8 })
        Text('åŠ è½½ä¸­...').fontSize(14).fontColor('#999999')
      } else if (this.currentPage > this.totalPages) {
        Text('æ²¡æœ‰æ›´å¤šäº†').fontSize(14).fontColor('#999999')
      }
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
  }

  private goToSearch(): void {
    router.pushUrl({
      url: 'pages/SearchPage'
    });
  }
  
  // åˆ†ç±»æ ç»„ä»¶
  @Builder CategoryBar() {
    Scroll(this.categoryScroller) {
      Row({ space: 16 }) {
        ForEach(this.categories, (category: CategoryConfig, index: number) => {
          Text(category.name)
            .fontSize(this.selectedCategory === category.id ? 16 : 14)
            .fontColor(this.selectedCategory === category.id 
              ? this.getColors().textPrimary
              : this.getColors().textTertiary)
            .fontWeight(this.selectedCategory === category.id 
              ? FontWeight.Bold 
              : FontWeight.Normal)
            .padding({ left: 8, right: 8, top: 8, bottom: 10 })
            .animation({
              duration: 200,
              curve: Curve.EaseInOut
            })
            .onClick(() => this.onCategoryChange(category.id, index))
        })
      }
      .padding({ left: 16, right: 16 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .width('100%')
    .height(44)
  }
  
  // ç­›é€‰é¢æ¿ç»„ä»¶
  @Builder FilterPanel() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => this.showFilterPanel = false)
      
      // ç­›é€‰å†…å®¹
      Column({ space: 16 }) {
        // é…’ç²¾åº¦é€‰æ‹©
        Column({ space: 8 }) {
          Text('é…’ç²¾åº¦')
            .fontSize(14)
            .fontColor(this.getColors().textSecondary)
            .width('100%')
          
          Row({ space: 8 }) {
            ForEach(this.abvRanges, (range: AbvRange) => {
              Text(range.name)
                .fontSize(13)
                .fontColor(this.selectedAbvRange === range.id
                  ? '#FFFFFF'
                  : this.getColors().textPrimary)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor(this.selectedAbvRange === range.id
                  ? '#FF6B00'
                  : (this.isDarkMode ? '#2A2A2A' : '#F5F5F5'))
                .borderRadius(4)
                .onClick(() => this.onAbvRangeChange(range.id))
            })
          }
          .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        
        // æ’åºé€‰æ‹©
        Column({ space: 8 }) {
          Text('æ’åº')
            .fontSize(14)
            .fontColor(this.getColors().textSecondary)
            .width('100%')
          
          Row({ space: 8 }) {
            ForEach(this.sortOptions, (option: SortOption) => {
              Text(option.name)
                .fontSize(13)
                .fontColor(this.sortType === option.id
                  ? '#FFFFFF'
                  : this.getColors().textPrimary)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor(this.sortType === option.id
                  ? '#FF6B00'
                  : (this.isDarkMode ? '#2A2A2A' : '#F5F5F5'))
                .borderRadius(4)
                .onClick(() => this.onSortChange(option.id))
            })
          }
          .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        
        // æŒ‰é’®ç»„
        Row({ space: 12 }) {
          Button('é‡ç½®')
            .fontSize(14)
            .fontColor(this.getColors().textPrimary)
            .backgroundColor(this.isDarkMode ? '#2A2A2A' : '#F5F5F5')
            .layoutWeight(1)
            .onClick(() => this.resetFilters())
          
          Button('ç¡®å®š')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF6B00')
            .layoutWeight(1)
            .onClick(() => this.showFilterPanel = false)
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .padding(16)
      .backgroundColor(this.getColors().cardBackground)
      .borderRadius({ topLeft: 12, topRight: 12 })
      .width('100%')
    }
    .width('100%')
    .height('100%')
  }

  build() {
    Stack() {
      Column() {
        // Header
        Row() {
          Text('å‘ç°') 
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColors().textPrimary)
          
          Blank()
          
          SymbolGlyph($r('sys.symbol.slider_horizontal_2'))
            .fontSize(22)
            .fontColor([this.getColors().textPrimary])
            .margin({ right: 12 })
            .onClick(() => this.showFilterPanel = true)
          
          SymbolGlyph($r('sys.symbol.magnifyingglass'))
            .fontSize(22)
            .fontColor([this.getColors().textPrimary])
            .onClick(() => this.goToSearch())
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor(this.getColors().cardBackground)

        // åˆ†ç±»æ 
        this.CategoryBar()

        if (this.recipesDataSource.totalCount() === 0 && !this.isLoading) {
           Column() {
               Text('æš‚æ— å†…å®¹').onClick(() => this.refresh())
           }.justifyContent(FlexAlign.Center).height('100%')
        } else {
          Refresh({ refreshing: $$this.isRefreshing, offset: 80, friction: 62 }) {
            WaterFlow({ footer: () => { this.footer() } }) {
              LazyForEach(this.recipesDataSource, (recipe: Recipe) => {
                FlowItem() {
                  RecipeCard({
                    recipe: recipe,
                    onTap: () => { this.openRecipeDetail(recipe.id) }
                  })
                }
                .width('100%')
              }, (recipe: Recipe) => recipe.id)
            }
            .columnsTemplate("1fr 1fr")
            .columnsGap(10)
            .rowsGap(10)
            .padding({ left: 10, right: 10, top: 10, bottom: 10 })
            .width('100%')
            .layoutWeight(1)
            .onReachEnd(() => {
                this.loadMore();
            })
          }
          .onStateChange((refreshStatus: RefreshStatus) => {
            console.info('[RecipesPage] ä¸‹æ‹‰åˆ·æ–°çŠ¶æ€å˜åŒ–:', refreshStatus);
          })
          .onRefreshing(() => {
            console.info('[RecipesPage] è§¦å‘ä¸‹æ‹‰åˆ·æ–°');
            this.handlePullRefresh();
          })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.getColors().background)
      
      // ç­›é€‰é¢æ¿ï¼ˆæ‚¬æµ®ï¼‰
      if (this.showFilterPanel) {
        this.FilterPanel()
      }
    }
    .width('100%')
    .height('100%')
  }
}

/**
 * é…æ–¹å¡ç‰‡ç»„ä»¶
 */
@Component
struct RecipeCard {
  @Prop recipe: Recipe;
  @StorageProp('isDarkMode') isDarkMode: boolean = false;
  @State avatarLoadError: boolean = false;
  onTap?: () => void;
  
  // é»˜è®¤å›¾ç‰‡å’Œå¤´åƒè·¯å¾„
  private readonly DEFAULT_WINE_IMAGE: string = '/uploads/cocktails/jiu.jpg';
  private readonly DEFAULT_AVATAR_PATH: string = '/uploads/avatars/test.jpg';
  
  private getColors(): ThemeColors {
    return this.isDarkMode ? DarkTheme : LightTheme;
  }
  
  /**
   * è·å–é…æ–¹å›¾ç‰‡URL
   * é‡‡ç”¨ RecipeDetailPage çš„æ¨¡å¼ï¼šæœ¬åœ°å›¾ç‰‡ä¸å­˜åœ¨æˆ–ä¸ºç©ºåˆ™ç”¨é»˜è®¤å›¾ç‰‡
   */
  private getImageSource(): string | Resource {
    // ä¼˜å…ˆä½¿ç”¨é…æ–¹çš„å›¾ç‰‡ï¼Œå¤±è´¥åˆ™ç”¨é»˜è®¤å›¾ç‰‡
    const imagePath = this.recipe.image || this.DEFAULT_WINE_IMAGE;
    return apiService.getFullImageUrl(imagePath);
  }

  /**
   * è·å–ä½œè€…å¤´åƒURL
   * ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ creatorAvatarï¼Œå¤±è´¥åˆ™ç”¨é»˜è®¤å¤´åƒ
   */
  private getAvatarSource(): string | Resource {
    if (this.avatarLoadError) {
      return apiService.getFullImageUrl(this.DEFAULT_AVATAR_PATH);
    }
    
    // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„å¤´åƒè·¯å¾„
    const avatarPath = Reflect.get(this.recipe, 'creatorAvatar') as string;
    if (avatarPath && avatarPath.length > 0) {
      return apiService.getFullImageUrl(avatarPath);
    }
    
    // é»˜è®¤å¤´åƒ
    return apiService.getFullImageUrl(this.DEFAULT_AVATAR_PATH);
  }

  build() {
    Column() {
      // é…æ–¹å›¾ç‰‡åŒºåŸŸ
      Image(this.getImageSource())
        .width('100%')
        .height(180)
        .objectFit(ImageFit.Cover)
        .borderRadius({ topLeft: 8, topRight: 8 })
        .alt($r('app.media.wine'))
        .onComplete(() => {
          console.info(`[RecipeCard] å›¾ç‰‡åŠ è½½æˆåŠŸ: ${this.recipe.name}`);
        })
        .onError(() => {
          console.error(`[RecipeCard] å›¾ç‰‡åŠ è½½å¤±è´¥: ${this.recipe.name}`);
          // åŠ è½½å¤±è´¥ï¼ŒImage ç»„ä»¶ä¼šä½¿ç”¨ alt çš„é»˜è®¤å›¾ç‰‡
        })
      
      // å†…å®¹åŒºåŸŸ
      Column() {
        // æ ‡é¢˜
        Text(this.recipe.name)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .fontColor(this.getColors().textPrimary)
          .width('100%')
          .textAlign(TextAlign.Start)
        
        // ABV + é…æ–™æ ‡ç­¾
        Row({ space: 4 }) {
          Text(`${this.recipe.estimatedAbv.toFixed(0)}%`)
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B00')
            .backgroundColor(this.isDarkMode ? '#3D2A1A' : '#FFF0E0')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
            .flexShrink(0)
          
          if (this.recipe.ingredients && typeof this.recipe.ingredients === 'string') {
            Text(this.recipe.ingredients.split(',').slice(0, 5).join(' '))
              .fontSize(10)
              .fontColor(this.getColors().textTertiary)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
        }
        .margin({ top: 6 })
        .width('100%')
        
        // ğŸ‘‡ åº•éƒ¨ä½œè€…å’Œäº’åŠ¨æ•°æ® - ä¿®æ”¹å¤´åƒéƒ¨åˆ†
        Row() {
          // å·¦è¾¹:å¤´åƒ+åå­—
          Row({ space: 8 }) {
            // ğŸ‘‡ æ›¿æ¢ä¸ºçœŸå®å¤´åƒ
            Image(this.getAvatarSource())
              .width(24)
              .height(24)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
              .flexShrink(0)
              .alt($r('app.media.profile_cat')) // åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
              .onError(() => {
                console.error(`[RecipeCard] å¤´åƒåŠ è½½å¤±è´¥: ${this.recipe.createdBy}`);
                // æœ¬åœ°å¤´åƒåŠ è½½å¤±è´¥ï¼Œæ ‡è®°ä¸ºå¤±è´¥ï¼Œä¸‹æ¬¡è°ƒç”¨ getAvatarSource ä¼šè¿”å›é»˜è®¤å¤´åƒ
                if (!this.avatarLoadError) {
                  this.avatarLoadError = true;
                }
              })
            
            Text(this.recipe.createdBy)
              .fontSize(10)
              .fontColor(this.getColors().textSecondary)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .layoutWeight(1)
          .alignItems(VerticalAlign.Center)
          
          // å³è¾¹:ç‚¹èµå’Œæ”¶è—æ•°é‡
          Row({ space: 8 }) {
            // ç‚¹èµ
            Row({ space: 2 }) {
              SymbolGlyph(this.recipe.isLiked ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
                .fontSize(12)
                .fontColor([this.recipe.isLiked ? '#FF4D4F' : this.getColors().textSecondary])
              Text(`${this.recipe.likeCount}`)
                .fontSize(12)
                .fontColor(this.getColors().textSecondary)
            }

            // æ”¶è—
            Row({ space: 2 }) {
              SymbolGlyph(this.recipe.isFavorited ? $r('sys.symbol.star_fill') : $r('sys.symbol.star'))
                .fontSize(12)
                .fontColor([this.recipe.isFavorited ? '#FFD700' : this.getColors().textSecondary])
              Text(`${this.recipe.favoriteCount}`)
                .fontSize(12)
                .fontColor(this.getColors().textSecondary)
            }
          }
          .flexShrink(0)
          .margin({ left: 4 })
        }
        .margin({ top: 8 })
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .justifyContent(FlexAlign.SpaceBetween)

      }
      .padding(8)
      .backgroundColor(this.getColors().cardBackground)
      .borderRadius({ bottomLeft: 8, bottomRight: 8 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .borderRadius(8)
    .backgroundColor(this.getColors().cardBackground)
    .shadow({ radius: 4, color: this.isDarkMode ? '#00000000' : '#1A000000', offsetY: 2 })
    .onClick(() => {
      if (this.onTap) this.onTap();
    })
  }
}
