// RecipesPage.ets - é…æ–¹åˆ—è¡¨é¡µé¢

import { apiService } from '../services/APIService';
import { Recipe, RecipesResponse, Ingredient } from '../models/Recipe';
import { router } from '@kit.ArkUI';

@Component
export struct RecipesPage {
  @State recipes: Array<Recipe> = [];
  @State isLoading: boolean = false;
  @State currentPage: number = 1;
  @State totalPages: number = 1;
  @State errorMessage: string = '';
  
  private pageSize: number = 100; // æ¯æ¬¡åŠ è½½100æ¡
  private sortType: string = 'default'; // default, likes, favorites, name

  aboutToAppear() {
    // é¡µé¢åŠ è½½æ—¶è·å–ç¬¬ä¸€é¡µæ•°æ®
    if (this.recipes.length === 0) {
      this.fetchRecipes(true);
    }
  }

  /**
   * è·å–é…æ–¹åˆ—è¡¨
   * @param reset æ˜¯å¦é‡ç½®åˆ—è¡¨(åˆ·æ–°)
   */
  private async fetchRecipes(reset: boolean) {
    if (this.isLoading) {
      return;
    }
    
    if (reset) {
      this.currentPage = 1;
      this.totalPages = 1;
      this.recipes = [];
    }
    
    this.isLoading = true;
    this.errorMessage = '';
    
    try {
      const result: object = await apiService.fetchRecipes(
        this.currentPage,
        this.pageSize,
        '', // æœç´¢å‚æ•°æš‚æ—¶ä¸ºç©º
        this.sortType
      );
      
      const response: RecipesResponse = result as RecipesResponse;
      const newRecipes: Array<Recipe> = response.recipes || [];
      
      if (reset) {
        this.recipes = newRecipes;
      } else {
        // è¿½åŠ æ–°æ•°æ®
        this.recipes = this.recipes.concat(newRecipes);
      }
      
      this.currentPage = response.currentPage + 1;
      this.totalPages = response.totalPages;
      
    } catch (error) {
      console.error('[RecipesPage] è·å–é…æ–¹å¤±è´¥:', error);
      this.errorMessage = 'åŠ è½½å¤±è´¥,è¯·ç¨åé‡è¯•';
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½æ›´å¤š
   */
  private loadMore() {
    if (this.currentPage <= this.totalPages && !this.isLoading) {
      this.fetchRecipes(false);
    }
  }

  /**
   * åˆ·æ–°åˆ—è¡¨
   */
  private refresh() {
    this.fetchRecipes(true);
  }

  /**
   * æ‰“å¼€é…æ–¹è¯¦æƒ…(è·¯ç”±è·³è½¬)
   */
  private openRecipeDetail(recipeId: string) {
    console.info(`[RecipesPage] openRecipeDetail - recipeId: ${recipeId}`);
    router.pushUrl({
      url: 'pages/RecipeDetailPage',
      params: {
        recipeId: recipeId
      }
    }).then(() => {
      console.info(`[RecipesPage] navigated to RecipeDetailPage`);
    }).catch((err: Error) => {
      console.error(`[RecipesPage] navigation failed: ${err.message}`);
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('é…æ–¹')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.Center)
      .backgroundColor(Color.White)
      
      // å†…å®¹åŒºåŸŸ
      if (this.recipes.length === 0 && !this.isLoading) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ¸')
            .fontSize(64)
            .opacity(0.3)
          
          Text('æš‚æ— é…æ–¹')
            .fontSize(18)
            .fontColor('#999999')
            .margin({ top: 16 })
          
          Text(this.errorMessage || 'å¯èƒ½æ˜¯åœ¨åŠ è½½ä¸­æˆ–è¿æ¥å¤±è´¥')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .margin({ top: 8 })
          
          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .margin({ top: 20 })
            .onClick(() => {
              this.refresh();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
      } else {
        // é…æ–¹ç½‘æ ¼åˆ—è¡¨
        Refresh({ refreshing: $$this.isLoading }) {
          List({ space: 12 }) {
            // ä½¿ç”¨Gridå¸ƒå±€åœ¨Listä¸­å®ç°å¡ç‰‡ç½‘æ ¼
            ListItem() {
              GridRow({ columns: 2, gutter: { x: 12, y: 12 } }) {
                ForEach(this.recipes, (recipe: Recipe) => {
                  GridCol() {
                    RecipeCard({
                      recipe: recipe,
                      onTap: () => {
                        this.openRecipeDetail(recipe.id);
                      }
                    })
                  }
                }, (recipe: Recipe) => recipe.id)
              }
              .padding({ left: 12, right: 12, top: 12 })
            }
            
            // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
            if (this.currentPage <= this.totalPages || this.isLoading) {
              ListItem() {
                Row() {
                  if (this.isLoading) {
                    LoadingProgress()
                      .width(30)
                      .height(30)
                      .margin({ right: 8 })
                    Text('åŠ è½½ä¸­...')
                      .fontSize(14)
                      .fontColor('#999999')
                  } else if (this.currentPage <= this.totalPages) {
                    Button('åŠ è½½æ›´å¤š')
                      .fontSize(14)
                      .type(ButtonType.Normal)
                      .borderRadius(20)
                      .backgroundColor('#1890ff')
                      .onClick(() => {
                        this.loadMore();
                      })
                  }
                }
                .width('100%')
                .height(60)
                .justifyContent(FlexAlign.Center)
              }
            }
          }
          .width('100%')
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .edgeEffect(EdgeEffect.Spring)
        }
        .onRefreshing(() => {
          this.refresh();
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}

/**
 * é…æ–¹å¡ç‰‡ç»„ä»¶
 */
@Component
struct RecipeCard {
  @Prop @Watch('onRecipeUpdate') recipe: Recipe;
  onTap?: () => void;
  
  @State likeCount: number = 0;
  @State favoriteCount: number = 0;
  @State isLiked: boolean = false;
  @State isFavorited: boolean = false;
  @State expanded: boolean = false;
  @State isLoadingDetail: boolean = false;
  @State ingredients: Array<Ingredient> = [];

  aboutToAppear() {
    this.syncRecipeState();
  }

  /**
   * ç›‘å¬recipeå˜åŒ–,åŒæ­¥çŠ¶æ€
   */
  onRecipeUpdate() {
    this.syncRecipeState();
  }

  /**
   * åŒæ­¥é…æ–¹çŠ¶æ€
   */
  private syncRecipeState() {
    // åŒæ­¥äº¤äº’çŠ¶æ€
    this.likeCount = this.recipe.likeCount || 0;
    this.favoriteCount = this.recipe.favoriteCount || 0;
    this.isLiked = this.recipe.isLiked || false;
    this.isFavorited = this.recipe.isFavorited || false;
    
    // å¦‚æœæœ‰é…æ–™å­—ç¬¦ä¸²,è§£æä¸ºæ•°ç»„
    if (typeof this.recipe.ingredients === 'string' && this.recipe.ingredients.length > 0) {
      const ingredientNames: Array<string> = this.recipe.ingredients.split(',');
      this.ingredients = ingredientNames.map((name: string): Ingredient => {
        const ingredient: Ingredient = {
          name: name.trim(),
          volume: 0
        };
        return ingredient;
      });
    }
  }

  /**
   * åˆ‡æ¢ç‚¹èµçŠ¶æ€
   */
  private async toggleLike() {
    // ä¹è§‚æ›´æ–°UI
    const originalLikeCount = this.likeCount;
    const originalIsLiked = this.isLiked;
    
    if (this.isLiked) {
      this.likeCount = Math.max(0, this.likeCount - 1);
      this.isLiked = false;
    } else {
      this.likeCount += 1;
      this.isLiked = true;
    }
    
    try {
      await apiService.toggleLike(this.recipe.id);
      console.info(`[RecipeCard] ç‚¹èµæ“ä½œæˆåŠŸ id=${this.recipe.id}`);
    } catch (error) {
      // å¤±è´¥æ—¶å›æ»š
      console.error('[RecipeCard] ç‚¹èµæ“ä½œå¤±è´¥:', error);
      this.likeCount = originalLikeCount;
      this.isLiked = originalIsLiked;
    }
  }

  /**
   * åˆ‡æ¢æ”¶è—çŠ¶æ€
   */
  private async toggleFavorite() {
    const originalFavoriteCount = this.favoriteCount;
    const originalIsFavorited = this.isFavorited;
    
    if (this.isFavorited) {
      this.favoriteCount = Math.max(0, this.favoriteCount - 1);
      this.isFavorited = false;
    } else {
      this.favoriteCount += 1;
      this.isFavorited = true;
    }
    
    try {
      await apiService.toggleFavorite(this.recipe.id);
      console.info(`[RecipeCard] æ”¶è—æ“ä½œæˆåŠŸ id=${this.recipe.id}`);
    } catch (error) {
      console.error('[RecipeCard] æ”¶è—æ“ä½œå¤±è´¥:', error);
      this.favoriteCount = originalFavoriteCount;
      this.isFavorited = originalIsFavorited;
    }
  }

  /**
   * åˆ‡æ¢å±•å¼€é…æ–™
   */
  private async toggleExpanded() {
    this.expanded = !this.expanded;
    
    // å¦‚æœå±•å¼€ä¸”æ²¡æœ‰è¯¦ç»†é…æ–™ä¿¡æ¯,åˆ™åŠ è½½è¯¦æƒ…
    if (this.expanded && this.ingredients.length === 0) {
      this.isLoadingDetail = true;
      try {
        const detail: object = await apiService.fetchRecipeDetail(this.recipe.id);
        const ingredientsData = Reflect.get(detail, 'ingredients') as Array<Ingredient>;
        if (ingredientsData && Array.isArray(ingredientsData)) {
          this.ingredients = ingredientsData;
        }
      } catch (error) {
        console.error('[RecipeCard] åŠ è½½é…æ–¹è¯¦æƒ…å¤±è´¥:', error);
      } finally {
        this.isLoadingDetail = false;
      }
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜ä¸ä½œè€…
      Column({ space: 6 }) {
        Text(this.recipe.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(`åˆ›å»ºè€…: ${this.recipe.createdBy}`)
          .fontSize(12)
          .fontColor('#999999')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // ABVæ ‡ç­¾
      Row() {
        Text(`${this.recipe.estimatedAbv.toFixed(1)}% ABV`)
          .fontSize(11)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1890ff')
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .backgroundColor('#E6F7FF')
          .borderRadius(6)
      }
      .width('100%')
      .margin({ top: 8 })

      // é¢„è§ˆé…æ–™æŒ‰é’®
      Row() {
        Blank()
        if (this.isLoadingDetail) {
          LoadingProgress()
            .width(20)
            .height(20)
        } else {
          Button(this.expanded ? 'æ”¶èµ·é…æ–™' : 'é¢„è§ˆé…æ–™')
            .fontSize(12)
            .height(28)
            .type(ButtonType.Normal)
            .borderRadius(14)
            .backgroundColor('#F0F0F0')
            .fontColor('#666666')
            .onClick(() => {
              this.toggleExpanded();
            })
        }
      }
      .width('100%')
      .margin({ top: 8 })

      // é…æ–™åˆ—è¡¨(å±•å¼€æ—¶æ˜¾ç¤º)
      if (this.expanded && this.ingredients.length > 0) {
        Column({ space: 6 }) {
          ForEach(this.ingredients, (ingredient: Ingredient) => {
            Row() {
              Text(ingredient.name)
                .fontSize(13)
                .fontColor('#333333')
                .layoutWeight(1)
              
              if (ingredient.volume > 0) {
                Text(`${ingredient.volume.toFixed(0)} ml`)
                  .fontSize(12)
                  .fontColor('#999999')
              }
            }
            .width('100%')
            .padding({ top: 4, bottom: 4 })
          }, (ingredient: Ingredient, index: number) => `${this.recipe.id}_ing_${index}`)
        }
        .width('100%')
        .padding(8)
        .backgroundColor('#FAFAFA')
        .borderRadius(8)
        .margin({ top: 8 })
      }

      // ç‚¹èµå’Œæ”¶è—æŒ‰é’®
      Row() {
        // ç‚¹èµ
        Row({ space: 6 }) {
          Text(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
            .fontSize(20)
          
          Text(`${this.likeCount}`)
            .fontSize(12)
            .fontColor('#999999')
        }
        .onClick(() => {
          this.toggleLike();
        })

        Blank()

        // æ”¶è—
        Row({ space: 6 }) {
          Text(this.isFavorited ? 'â­' : 'â˜†')
            .fontSize(20)
            .fontColor(this.isFavorited ? '#FFD700' : '#999999')
          
          if (this.favoriteCount > 0) {
            Text(`${this.favoriteCount}`)
              .fontSize(12)
              .fontColor('#999999')
          }
        }
        .onClick(() => {
          this.toggleFavorite();
        })
      }
      .width('100%')
      .margin({ top: 10 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      console.info(`[RecipeCard] onClick - recipe id: ${this.recipe.id}`);
      if (this.onTap) {
        this.onTap();
      } else {
        console.warn('[RecipeCard] onTap callback is not defined');
      }
    })
  }
}
