// SettingsPage.ets - è®¾ç½®é¡µé¢
// å‚è€ƒ Swift é¡¹ç›®ä¸­çš„ SettingsFullScreen å’Œ AppearanceSettings/LanguageSettings

import { router } from '@kit.ArkUI';
import APIService from '../services/APIService';
import promptAction from '@ohos.promptAction';
import preferences from '@ohos.data.preferences';
import { common } from '@kit.AbilityKit';

// å¤–è§‚æ¨¡å¼æšä¸¾
export enum AppearanceMode {
  SYSTEM = 'system',
  LIGHT = 'light',
  DARK = 'dark'
}

// è¯­è¨€æšä¸¾
export enum AppLanguage {
  SYSTEM = 'system',
  ZH_HANS = 'zh-Hans',
  EN = 'en'
}

/**
 * è®¾ç½®ç®¡ç†ç±» - å•ä¾‹æ¨¡å¼
 */
export class SettingsManager {
  private static instance: SettingsManager;
  private preferences?: preferences.Preferences;
  
  // è®¾ç½®é¡¹
  private _appearanceMode: AppearanceMode = AppearanceMode.SYSTEM;
  private _language: AppLanguage = AppLanguage.SYSTEM;
  private _aiCacheTTLDays: number = 7;
  
  private constructor() {}
  
  public static getInstance(): SettingsManager {
    if (!SettingsManager.instance) {
      SettingsManager.instance = new SettingsManager();
    }
    return SettingsManager.instance;
  }
  
  /**
   * åˆå§‹åŒ–è®¾ç½®
   */
  public async initialize(context: common.UIAbilityContext): Promise<void> {
    try {
      this.preferences = await preferences.getPreferences(context, 'app_settings');
      await this.loadSettings();
    } catch (error) {
      console.error('[SettingsManager] åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }
  
  /**
   * åŠ è½½è®¾ç½®
   */
  private async loadSettings(): Promise<void> {
    if (!this.preferences) return;
    
    try {
      // åŠ è½½å¤–è§‚æ¨¡å¼
      const appearanceStr = await this.preferences.get('appearanceMode', AppearanceMode.SYSTEM) as string;
      this._appearanceMode = appearanceStr as AppearanceMode;
      
      // åŠ è½½è¯­è¨€
      const languageStr = await this.preferences.get('language', AppLanguage.SYSTEM) as string;
      this._language = languageStr as AppLanguage;
      
      // åŠ è½½AIç¼“å­˜TTL
      const ttl = await this.preferences.get('aiCacheTTLDays', 7) as number;
      this._aiCacheTTLDays = ttl;
      
      console.info('[SettingsManager] è®¾ç½®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('[SettingsManager] åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
  }
  
  /**
   * ä¿å­˜è®¾ç½®
   */
  private async saveSettings(): Promise<void> {
    if (!this.preferences) return;
    
    try {
      await this.preferences.put('appearanceMode', this._appearanceMode);
      await this.preferences.put('language', this._language);
      await this.preferences.put('aiCacheTTLDays', this._aiCacheTTLDays);
      await this.preferences.flush();
    } catch (error) {
      console.error('[SettingsManager] ä¿å­˜è®¾ç½®å¤±è´¥:', error);
    }
  }
  
  // Getters and Setters
  public get appearanceMode(): AppearanceMode {
    return this._appearanceMode;
  }
  
  public async setAppearanceMode(mode: AppearanceMode): Promise<void> {
    this._appearanceMode = mode;
    await this.saveSettings();
  }
  
  public get language(): AppLanguage {
    return this._language;
  }
  
  public async setLanguage(lang: AppLanguage): Promise<void> {
    this._language = lang;
    await this.saveSettings();
  }
  
  public get aiCacheTTLDays(): number {
    return this._aiCacheTTLDays;
  }
  
  public async setAICacheTTLDays(days: number): Promise<void> {
    this._aiCacheTTLDays = days;
    await this.saveSettings();
  }
  
  /**
   * è·å–å¤–è§‚æ¨¡å¼æ˜¾ç¤ºåç§°
   */
  public getAppearanceModeLabel(mode: AppearanceMode): string {
    switch (mode) {
      case AppearanceMode.SYSTEM:
        return 'è·Ÿéšç³»ç»Ÿ';
      case AppearanceMode.LIGHT:
        return 'æµ…è‰²';
      case AppearanceMode.DARK:
        return 'æ·±è‰²';
      default:
        return 'è·Ÿéšç³»ç»Ÿ';
    }
  }
  
  /**
   * è·å–è¯­è¨€æ˜¾ç¤ºåç§°
   */
  public getLanguageLabel(lang: AppLanguage): string {
    switch (lang) {
      case AppLanguage.SYSTEM:
        return 'è·Ÿéšç³»ç»Ÿ';
      case AppLanguage.ZH_HANS:
        return 'ç®€ä½“ä¸­æ–‡';
      case AppLanguage.EN:
        return 'English';
      default:
        return 'è·Ÿéšç³»ç»Ÿ';
    }
  }
}

/**
 * è®¾ç½®é¡µé¢ç»„ä»¶
 */
@Entry
@Component
export struct SettingsPage {
  @State appearanceMode: AppearanceMode = AppearanceMode.SYSTEM;
  @State language: AppLanguage = AppLanguage.SYSTEM;
  @State aiCacheTTLDays: number = 7;
  @State userName: string = '';
  @State userRole: string = '';
  @State isAdmin: boolean = false;
  @State showLogoutDialog: boolean = false;
  @State showLanguageDialog: boolean = false;
  @State pendingLanguage: AppLanguage = AppLanguage.SYSTEM;
  
  private settingsManager = SettingsManager.getInstance();
  private readonly cacheTTLOptions: number[] = [1, 3, 7, 14, 30];
  
  aboutToAppear() {
    // åŠ è½½è®¾ç½®
    this.appearanceMode = this.settingsManager.appearanceMode;
    this.language = this.settingsManager.language;
    this.aiCacheTTLDays = this.settingsManager.aiCacheTTLDays;
    
    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    const apiService = APIService.getInstance();
    if (apiService.currentUser) {
      this.userName = apiService.currentUser.username;
      this.userRole = apiService.currentUser.role;
      this.isAdmin = this.userRole === 'admin';
    }
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Row({ space: 4 }) {
            Text('â†')
              .fontSize(24)
              .fontColor('#007DFF')
            Text('è¿”å›')
              .fontSize(16)
              .fontColor('#007DFF')
          }
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .height(44)
        .padding({ left: 4, right: 12 })
        .onClick(() => {
          router.back();
        })
        
        Text('è®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ä¿æŒæ ‡é¢˜å±…ä¸­
        Row()
          .width(80)
      }
      .width('100%')
      .height(56)
      .padding({ left: 8, right: 16 })
      .backgroundColor(Color.White)
      
      // è®¾ç½®å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          // å¤–è§‚è®¾ç½®
          this.buildAppearanceSection();
          
          // è¯­è¨€è®¾ç½®
          this.buildLanguageSection();
          
          // AIç¼“å­˜è®¾ç½®
          this.buildAICacheSection();
          
          // è´¦æˆ·è®¾ç½®
          this.buildAccountSection();
          
          // å…³äº
          this.buildAboutSection();
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
    .bindSheet(this.showLogoutDialog, this.buildLogoutDialog(), {
      height: 200,
      backgroundColor: Color.White,
      onDisappear: () => {
        this.showLogoutDialog = false;
      }
    })
    .bindSheet(this.showLanguageDialog, this.buildLanguageDialog(), {
      height: 300,
      backgroundColor: Color.White,
      onDisappear: () => {
        this.showLanguageDialog = false;
      }
    })
  }
  
  /**
   * é€€å‡ºç™»å½•å¯¹è¯æ¡†
   */
  @Builder
  buildLogoutDialog() {
    Column({ space: 20 }) {
      Text('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .textAlign(TextAlign.Center)
        .padding({ top: 20 })
      
      Text('é€€å‡ºåå°†æ— æ³•ä½¿ç”¨å®Œæ•´åŠŸèƒ½')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
      
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .fontColor('#333333')
          .onClick(() => {
            this.showLogoutDialog = false;
          })
        
        Button('é€€å‡º')
          .layoutWeight(1)
          .backgroundColor('#FF3B30')
          .fontColor(Color.White)
          .onClick(async () => {
            this.showLogoutDialog = false;
            try {
              await APIService.getInstance().logout();
              promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
              router.back();
            } catch (error) {
              promptAction.showToast({ message: 'é€€å‡ºç™»å½•å¤±è´¥' });
            }
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 20 })
    }
    .width('100%')
  }
  
  /**
   * è¯­è¨€é€‰æ‹©å¯¹è¯æ¡†
   */
  @Builder
  buildLanguageDialog() {
    Column({ space: 0 }) {
      Text('é€‰æ‹©è¯­è¨€')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .textAlign(TextAlign.Center)
        .padding({ top: 20, bottom: 16 })
      
      // è¯­è¨€é€‰é¡¹
      Column({ space: 0 }) {
        this.buildLanguageOption(AppLanguage.SYSTEM, 'è·Ÿéšç³»ç»Ÿ');
        Divider().color('#F0F0F0');
        this.buildLanguageOption(AppLanguage.ZH_HANS, 'ç®€ä½“ä¸­æ–‡');
        Divider().color('#F0F0F0');
        this.buildLanguageOption(AppLanguage.EN, 'English');
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
      
      Button('å…³é—­')
        .width('90%')
        .margin({ top: 20, bottom: 20 })
        .onClick(() => {
          this.showLanguageDialog = false;
        })
    }
    .width('100%')
  }
  
  /**
   * è¯­è¨€é€‰é¡¹
   */
  @Builder
  buildLanguageOption(lang: AppLanguage, label: string) {
    Row() {
      Text(label)
        .fontSize(16)
        .layoutWeight(1)
      
      if (this.language === lang) {
        Text('âœ“')
          .fontSize(20)
          .fontColor('#007DFF')
          .fontWeight(FontWeight.Bold)
      }
    }
    .width('100%')
    .height(50)
    .onClick(async () => {
      if (this.language !== lang) {
        this.language = lang;
        await this.settingsManager.setLanguage(lang);
        promptAction.showToast({ 
          message: 'è¯­è¨€å·²åˆ‡æ¢ï¼Œé‡å¯åº”ç”¨åç”Ÿæ•ˆ',
          duration: 2000
        });
      }
      this.showLanguageDialog = false;
    })
  }
  
  /**
   * å¤–è§‚è®¾ç½®åŒºåŸŸ
   */
  @Builder
  buildAppearanceSection() {
    Column({ space: 0 }) {
      // æ ‡é¢˜
      Text('å¤–è§‚')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .padding({ left: 16, bottom: 8 })
      
      // è®¾ç½®é¡¹
      Column({ space: 0 }) {
        // è·Ÿéšç³»ç»Ÿ
        Row() {
          Text('è·Ÿéšç³»ç»Ÿ')
            .fontSize(16)
            .layoutWeight(1)
          
          Toggle({ type: ToggleType.Switch, isOn: this.appearanceMode === AppearanceMode.SYSTEM })
            .onChange((isOn: boolean) => {
              if (isOn) {
                this.appearanceMode = AppearanceMode.SYSTEM;
                this.settingsManager.setAppearanceMode(AppearanceMode.SYSTEM);
              } else {
                this.appearanceMode = AppearanceMode.LIGHT;
                this.settingsManager.setAppearanceMode(AppearanceMode.LIGHT);
              }
            })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        
        // æ·±è‰²æ¨¡å¼ï¼ˆä»…åœ¨éè·Ÿéšç³»ç»Ÿæ—¶æ˜¾ç¤ºï¼‰
        if (this.appearanceMode !== AppearanceMode.SYSTEM) {
          Divider()
            .color('#F0F0F0')
            .padding({ left: 16, right: 16 })
          
          Row() {
            Text('æ·±è‰²æ¨¡å¼')
              .fontSize(16)
              .layoutWeight(1)
            
            Toggle({ type: ToggleType.Switch, isOn: this.appearanceMode === AppearanceMode.DARK })
              .onChange((isOn: boolean) => {
                const newMode = isOn ? AppearanceMode.DARK : AppearanceMode.LIGHT;
                this.appearanceMode = newMode;
                this.settingsManager.setAppearanceMode(newMode);
              })
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
        }
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
  }
  
  /**
   * è¯­è¨€è®¾ç½®åŒºåŸŸ
   */
  @Builder
  buildLanguageSection() {
    Column({ space: 0 }) {
      // æ ‡é¢˜
      Text('è¯­è¨€')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .padding({ left: 16, bottom: 8 })
      
      // è®¾ç½®é¡¹
      Column({ space: 0 }) {
        Row() {
          Text('åº”ç”¨è¯­è¨€')
            .fontSize(16)
          
          Blank()
          
          Text(this.settingsManager.getLanguageLabel(this.language))
            .fontSize(14)
            .fontColor('#999999')
            .margin({ right: 8 })
          
          Text('â€º')
            .fontSize(20)
            .fontColor('#999999')
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .onClick(() => {
          this.showLanguageDialog = true;
        })
        
        Divider()
          .color('#F0F0F0')
          .padding({ left: 16, right: 16 })
        
        // æç¤ºä¿¡æ¯
        Row() {
          Text('åˆ‡æ¢è¯­è¨€åéœ€è¦é‡å¯åº”ç”¨ç”Ÿæ•ˆ')
            .fontSize(12)
            .fontColor('#999999')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
  }
  
  /**
   * AIç¼“å­˜è®¾ç½®åŒºåŸŸ
   */
  @Builder
  buildAICacheSection() {
    Column({ space: 0 }) {
      // æ ‡é¢˜
      Text('AIç¼“å­˜')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .padding({ left: 16, bottom: 8 })
      
      // è®¾ç½®é¡¹
      Column({ space: 0 }) {
        Row() {
          Text('ç¼“å­˜æœ‰æ•ˆæœŸ')
            .fontSize(16)
          
          Blank()
          
          Text(`${this.aiCacheTTLDays} å¤©`)
            .fontSize(14)
            .fontColor('#999999')
            .margin({ right: 8 })
          
          Text('â€º')
            .fontSize(20)
            .fontColor('#999999')
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .onClick(() => {
          // TODO: æ˜¾ç¤ºé€‰æ‹©å™¨
          promptAction.showToast({ message: 'åŠŸèƒ½å¼€å‘ä¸­...' });
        })
        
        Divider()
          .color('#F0F0F0')
          .padding({ left: 16, right: 16 })
        
        // æ¸…é™¤ç¼“å­˜
        Row() {
          Text('ğŸ—‘ï¸')
            .fontSize(20)
            .margin({ right: 12 })
          
          Text('æ¸…é™¤ç¼“å­˜')
            .fontSize(16)
            .fontColor('#FF3B30')
          
          Blank()
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .onClick(() => {
          // TODO: æ¸…é™¤ç¼“å­˜
          promptAction.showToast({ 
            message: 'ç¼“å­˜å·²æ¸…é™¤',
            duration: 2000
          });
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
  }
  
  /**
   * è´¦æˆ·è®¾ç½®åŒºåŸŸ
   */
  @Builder
  buildAccountSection() {
    Column({ space: 0 }) {
      // æ ‡é¢˜
      Text('è´¦æˆ·')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .padding({ left: 16, bottom: 8 })
      
      // è®¾ç½®é¡¹
      Column({ space: 0 }) {
        // ç®¡ç†å‘˜é¢æ¿ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
        if (this.isAdmin) {
          Row() {
            Text('âš™ï¸')
              .fontSize(20)
              .margin({ right: 12 })
            
            Text('ç®¡ç†å‘˜é¢æ¿')
              .fontSize(16)
            
            Blank()
            
            Text('â€º')
              .fontSize(20)
              .fontColor('#999999')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            promptAction.showToast({ message: 'åŠŸèƒ½å¼€å‘ä¸­...' });
          })
          
          Divider()
            .color('#F0F0F0')
            .padding({ left: 16, right: 16 })
        }
        
        // é€€å‡ºç™»å½•
        Row() {
          Text('ğŸšª')
            .fontSize(20)
            .margin({ right: 12 })
          
          Text('é€€å‡ºç™»å½•')
            .fontSize(16)
            .fontColor('#FF3B30')
          
          Blank()
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .onClick(() => {
          this.showLogoutDialog = true;
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
  }
  
  /**
   * å…³äºåŒºåŸŸ
   */
  @Builder
  buildAboutSection() {
    Column({ space: 0 }) {
      // æ ‡é¢˜
      Text('å…³äº')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .padding({ left: 16, bottom: 8 })
      
      // è®¾ç½®é¡¹
      Column({ space: 0 }) {
        // ç‰ˆæœ¬
        Row() {
          Text('ç‰ˆæœ¬')
            .fontSize(16)
          
          Blank()
          
          Text('2.0.0')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        
        Divider()
          .color('#F0F0F0')
          .padding({ left: 16, right: 16 })
        
        // å¼€å‘è€…
        Row() {
          Text('å¼€å‘è€…')
            .fontSize(16)
          
          Blank()
          
          Text('Cybar Team')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
  }
}
