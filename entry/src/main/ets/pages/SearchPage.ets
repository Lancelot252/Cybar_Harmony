// SearchPage.ets - æœç´¢é¡µé¢
// å‚è€ƒ Swift SearchView.swift å’Œ server.js /api/recipes å®ç°
// æ”¯æŒæŒ‰é…æ–¹åç§°æœç´¢,å®æ—¶æœç´¢,åˆ†é¡µåŠ è½½

import { Recipe } from '../models/Recipe';
import APIService from '../services/APIService';
import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';

@Entry
@Component
export struct SearchPage {
  // å…è®¸ä»å¤–éƒ¨ç»‘å®š(ç”¨äº Tab å¯¼èˆª),ä¹Ÿå¯ä»¥ç‹¬ç«‹ä½¿ç”¨
  @State searchText: string = '';
  @State recipes: Array<Recipe> = [];
  @State isLoading: boolean = false;
  @State currentPage: number = 1;
  @State totalPages: number = 1;
  @State hasError: boolean = false;
  @State errorMessage: string = '';
  
  // å¯é€‰çš„å…³é—­å›è°ƒ(ç”¨äºåµŒå…¥æ¨¡å¼)
  onClose?: () => void;
  
  // é˜²æŠ–å®šæ—¶å™¨
  private debounceTimer: number = -1;
  private readonly pageSize: number = 20;
  private readonly debounceDelay: number = 300; // 300ms é˜²æŠ–å»¶è¿Ÿ
  
  aboutToAppear() {
    console.info('[SearchPage] ========================================');
    console.info('[SearchPage] Page appeared (aboutToAppear)');
    console.info('[SearchPage] Initial state - searchText: "%s"', this.searchText);
    console.info('[SearchPage] Initial state - recipes.length: %d', this.recipes.length);
    console.info('[SearchPage] ========================================');
    
    // æµ‹è¯•APIè¿æ¥
    this.testAPIConnection();
  }
  
  /**
   * æµ‹è¯•APIè¿æ¥
   */
  private async testAPIConnection() {
    try {
      console.info('[SearchPage] Testing API connection...');
      const apiService = APIService.getInstance();
      
      // å°è¯•è·å–ç¬¬ä¸€é¡µæ•°æ®æ¥æµ‹è¯•è¿æ¥
      await apiService.fetchRecipes(1, 1, '', 'default');
      console.info('[SearchPage] API connection test PASSED âœ“');
    } catch (error) {
      console.error('[SearchPage] API connection test FAILED âœ—');
      console.error('[SearchPage] Error:', error);
      
      // ä¸æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·ï¼Œå› ä¸ºè¿™åªæ˜¯é¢„æ£€æµ‹
      // ç”¨æˆ·æœç´¢æ—¶ä¼šçœ‹åˆ°å®é™…é”™è¯¯
    }
  }
  
  aboutToDisappear() {
    console.info('[SearchPage] ========================================');
    console.info('[SearchPage] Page disappearing (aboutToDisappear)');
    
    // æ¸…ç†å®šæ—¶å™¨
    if (this.debounceTimer !== -1) {
      console.info('[SearchPage] Cleaning up debounce timer');
      clearTimeout(this.debounceTimer);
      this.debounceTimer = -1;
    }
    
    console.info('[SearchPage] Page cleanup complete');
    console.info('[SearchPage] ========================================');
  }
  
  /**
   * æ‰§è¡Œæœç´¢ (å¸¦é˜²æŠ–)
   */
  private performSearch() {
    console.info(`[SearchPage] performSearch called - searchText: "${this.searchText}"`);
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.debounceTimer !== -1) {
      console.info(`[SearchPage] Clearing previous debounce timer`);
      clearTimeout(this.debounceTimer);
    }
    
    // å¦‚æœæœç´¢æ¡†ä¸ºç©º,æ¸…ç©ºç»“æœ
    if (this.searchText.trim() === '') {
      console.info(`[SearchPage] Search text is empty, clearing results`);
      this.recipes = [];
      this.currentPage = 1;
      this.totalPages = 1;
      this.hasError = false;
      return;
    }
    
    // è®¾ç½®æ–°çš„é˜²æŠ–å®šæ—¶å™¨
    console.info(`[SearchPage] Setting debounce timer for ${this.debounceDelay}ms`);
    this.debounceTimer = setTimeout(() => {
      console.info(`[SearchPage] Debounce timer fired, executing search`);
      this.fetchRecipes(true);
    }, this.debounceDelay);
  }
  
  /**
   * è·å–æœç´¢ç»“æœ
   * @param reset æ˜¯å¦é‡ç½®åˆ—è¡¨(é‡æ–°æœç´¢)
   */
  private async fetchRecipes(reset: boolean) {
    const query = this.searchText.trim();
    
    console.info(`[SearchPage] ========== fetchRecipes START ==========`);
    console.info(`[SearchPage] Query: "${query}", Reset: ${reset}, CurrentPage: ${this.currentPage}`);
    
    if (query === '') {
      console.info(`[SearchPage] Query is empty, clearing results`);
      this.recipes = [];
      return;
    }
    
    if (reset) {
      console.info(`[SearchPage] Resetting search - clearing recipes and setting page to 1`);
      this.currentPage = 1;
      this.recipes = [];
    }
    
    this.isLoading = true;
    this.hasError = false;
    this.errorMessage = '';
    
    try {
      console.info(`[SearchPage] Calling API - page: ${this.currentPage}, limit: ${this.pageSize}, query: "${query}"`);
      
      const apiService = APIService.getInstance();
      const result: object = await apiService.fetchRecipes(
        this.currentPage,
        this.pageSize,
        query,
        'created'  // ä½¿ç”¨ 'created' æ’åºï¼Œä¸Swiftç‰ˆæœ¬ä¸€è‡´
      );
      
      console.info(`[SearchPage] API call succeeded, parsing response...`);
      
      // è§£æå“åº”
      const recipesData = Reflect.get(result, 'recipes') as Array<object>;
      const totalPages = Reflect.get(result, 'totalPages') as number;
      const currentPage = Reflect.get(result, 'currentPage') as number;
      
      console.info(`[SearchPage] Parsed data - recipes count: ${recipesData?.length || 0}`);
      
      if (recipesData && Array.isArray(recipesData)) {
        const newRecipes = this.parseRecipesData(recipesData);
        
        if (reset) {
          this.recipes = newRecipes;
        } else {
          this.recipes = this.recipes.concat(newRecipes);
        }
        
        this.totalPages = totalPages || 1;
        this.currentPage = currentPage || 1;
        
        console.info(`[SearchPage] Success - total recipes: ${this.recipes.length}`);
        
        // Fallback: å¦‚æœæ˜¯é¦–æ¬¡æœç´¢ä¸”ç»“æœä¸ºç©ºï¼Œå°è¯•æ‹‰å–æ‰€æœ‰æ•°æ®åœ¨æœ¬åœ°è¿‡æ»¤
        if (reset && newRecipes.length === 0 && query !== '') {
          console.info(`[SearchPage] No results from server, trying local filter fallback...`);
          await this.fetchAndFilterLocally(query);
        }
      }
      
    } catch (error) {
      console.error('[SearchPage] ========== Search FAILED ==========');
      console.error('[SearchPage] Error:', error);
      console.error('[SearchPage] Error message:', error instanceof Error ? error.message : String(error));
      
      // å¦‚æœæœåŠ¡å™¨æœç´¢å¤±è´¥ï¼ˆæ¯”å¦‚500é”™è¯¯ï¼‰ï¼Œå°è¯•fallbackæ–¹æ¡ˆ
      if (reset && error instanceof Error && error.message.includes('500')) {
        console.info(`[SearchPage] Server search failed (500), trying local filter fallback...`);
        try {
          await this.fetchAndFilterLocally(query);
          return; // æˆåŠŸåˆ™è¿”å›ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
        } catch (fallbackError) {
          console.error('[SearchPage] Fallback also failed:', fallbackError);
        }
      }
      
      this.hasError = true;
      this.errorMessage = this.formatErrorMessage(error);
      
      promptAction.showToast({ 
        message: 'æœç´¢å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
      console.info(`[SearchPage] ========== fetchRecipes END ==========`);
    }
  }
  
  /**
   * Fallbackæ–¹æ¡ˆï¼šæ‹‰å–æ‰€æœ‰æ•°æ®å¹¶åœ¨æœ¬åœ°è¿‡æ»¤
   * å‚è€ƒSwift SearchViewçš„fetchFallbackAllAndFilteræ–¹æ³•
   */
  private async fetchAndFilterLocally(query: string) {
    console.info(`[SearchPage] fetchAndFilterLocally - query: "${query}"`);
    
    try {
      const apiService = APIService.getInstance();
      // æ‹‰å–æ‰€æœ‰æ•°æ®ï¼ˆä¸å¸¦æœç´¢æ¡ä»¶ï¼‰
      const result: object = await apiService.fetchRecipes(
        1,
        100,  // æ‹‰å–è¾ƒå¤šæ•°æ®ç”¨äºæœ¬åœ°è¿‡æ»¤
        '',   // ç©ºæœç´¢è¯
        'created'
      );
      
      const allRecipes = Reflect.get(result, 'recipes') as Array<object>;
      
      if (allRecipes && Array.isArray(allRecipes)) {
        console.info(`[SearchPage] Got ${allRecipes.length} recipes for local filtering`);
        
        const parsedRecipes = this.parseRecipesData(allRecipes);
        
        // æœ¬åœ°è¿‡æ»¤ï¼šæŒ‰åç§°æˆ–åˆ›å»ºè€…åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        const queryLower = query.toLowerCase();
        const filtered = parsedRecipes.filter((recipe: Recipe) => {
          const nameMatch = recipe.name.toLowerCase().includes(queryLower);
          const creatorMatch = recipe.createdBy.toLowerCase().includes(queryLower);
          return nameMatch || creatorMatch;
        });
        
        console.info(`[SearchPage] Local filter found ${filtered.length} matching recipes`);
        
        this.recipes = filtered;
        this.currentPage = 1;
        this.totalPages = 1;
        this.hasError = false;
      }
    } catch (err) {
      console.error('[SearchPage] fetchAndFilterLocally failed:', err);
      // ArkTSä¸å…è®¸throwä»»æ„ç±»å‹ï¼Œéœ€è¦è½¬æ¢ä¸ºError
      if (err instanceof Error) {
        throw err;
      } else {
        throw new Error('æœ¬åœ°è¿‡æ»¤å¤±è´¥');
      }
    }
  }
  
  /**
   * è§£æé…æ–¹æ•°æ®æ•°ç»„
   */
  private parseRecipesData(recipesData: Array<object>): Array<Recipe> {
    return recipesData.map((item: object): Recipe => {
      const id = Reflect.get(item, 'id') as string;
      const name = Reflect.get(item, 'name') as string;
      const createdBy = Reflect.get(item, 'createdBy') as string;
      const estimatedAbvValue = Reflect.get(item, 'estimatedAbv') as string | number | object | null;
      const likeCountValue = Reflect.get(item, 'likeCount') as string | number | object | null;
      const favoriteCountValue = Reflect.get(item, 'favoriteCount') as string | number | object | null;
      const ingredients = Reflect.get(item, 'ingredients') as string;
      
      return {
        id: id,
        name: name,
        createdBy: createdBy,
        instructions: Reflect.get(item, 'instructions') as string,
        estimatedAbv: this.parseNumber(estimatedAbvValue),
        likeCount: this.parseNumber(likeCountValue),
        favoriteCount: this.parseNumber(favoriteCountValue),
        ingredients: ingredients
      };
    });
  }
  
  /**
   * æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯
   */
  private formatErrorMessage(error: Error | object): string {
    if (!(error instanceof Error)) {
      return 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•';
    }
    
    const msg = error.message;
    
    if (msg.includes('500')) {
      return 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500)\n\nå·²å°è¯•æœ¬åœ°è¿‡æ»¤ä½†ä»å¤±è´¥\nè¯·ç¨åé‡è¯•';
    } else if (msg.includes('404')) {
      return 'APIæ¥å£æœªæ‰¾åˆ° (404)\n\nè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®';
    } else if (msg.includes('NETWORK_ERROR') || msg.includes('ç½‘ç»œ')) {
      return 'ç½‘ç»œè¿æ¥å¤±è´¥\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ è®¾å¤‡ç½‘ç»œè¿æ¥\nâ€¢ æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿';
    } else if (msg.includes('timeout') || msg.includes('è¶…æ—¶')) {
      return 'è¯·æ±‚è¶…æ—¶\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥é€Ÿåº¦';
    } else {
      return `${msg}\n\nè¯·é‡è¯•æˆ–æŸ¥çœ‹æ—¥å¿—`;
    }
  }
  
  /**
   * åŠ è½½æ›´å¤š
   */
  private loadMore() {
    console.info(`[SearchPage] loadMore called - isLoading: ${this.isLoading}, currentPage: ${this.currentPage}, totalPages: ${this.totalPages}`);
    
    if (this.isLoading) {
      console.info(`[SearchPage] Already loading, skipping loadMore`);
      return;
    }
    
    if (this.currentPage >= this.totalPages) {
      console.info(`[SearchPage] Already at last page, skipping loadMore`);
      return;
    }
    
    console.info(`[SearchPage] Loading more - incrementing page from ${this.currentPage} to ${this.currentPage + 1}`);
    this.currentPage++;
    this.fetchRecipes(false);
  }
  
  /**
   * å®‰å…¨åœ°è§£ææ•°å€¼
   */
  private parseNumber(value: string | number | object | null): number {
    if (value === null || value === undefined) {
      return 0;
    }
    if (typeof value === 'number') {
      return value;
    }
    if (typeof value === 'string') {
      const parsed = parseFloat(value);
      return isNaN(parsed) ? 0 : parsed;
    }
    const parsed = parseFloat(String(value));
    return isNaN(parsed) ? 0 : parsed;
  }
  
  /**
   * è·³è½¬åˆ°é…æ–¹è¯¦æƒ…
   */
  private navigateToDetail(recipe: Recipe) {
    router.pushUrl({
      url: 'pages/RecipeDetailPage',
      params: {
        recipeId: recipe.id
      }
    }).catch((error: Error) => {
      console.error('[SearchPage] Navigation failed:', error);
      promptAction.showToast({ message: 'è·³è½¬å¤±è´¥' });
    });
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨æœç´¢æ 
      this.buildSearchBar();
      
      // å†…å®¹åŒºåŸŸ
      if (this.searchText.trim() === '') {
        // ç©ºçŠ¶æ€ - æœç´¢æç¤º
        this.buildEmptyState();
      } else if (this.isLoading && this.recipes.length === 0) {
        // é¦–æ¬¡åŠ è½½çŠ¶æ€
        this.buildLoadingState();
      } else if (this.hasError) {
        // é”™è¯¯çŠ¶æ€
        this.buildErrorState();
      } else if (this.recipes.length === 0) {
        // æ— æœç´¢ç»“æœ
        this.buildNoResultsState();
      } else {
        // æœç´¢ç»“æœåˆ—è¡¨
        this.buildResultsList();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  
  /**
   * æ„å»ºæœç´¢æ 
   */
  @Builder
  buildSearchBar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button() {
        Row({ space: 4 }) {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
          Text('è¿”å›')
            .fontSize(16)
            .fontColor('#333333')
        }
      }
      .type(ButtonType.Normal)
      .backgroundColor(Color.Transparent)
      .height(44)
      .padding({ left: 4, right: 12 })
      .onClick(() => {
        // å¦‚æœæœ‰å…³é—­å›è°ƒåˆ™è°ƒç”¨,å¦åˆ™è¿”å›ä¸Šä¸€é¡µ
        if (this.onClose) {
          this.onClose();
        } else {
          router.back();
        }
      })
      
      // æœç´¢è¾“å…¥æ¡†
      Row() {
        Text('ğŸ”')
          .fontSize(18)
          .margin({ right: 8 })
        
        TextInput({ 
          placeholder: 'æœç´¢é…æ–¹åç§°...',
          text: $$this.searchText 
        })
          .layoutWeight(1)
          .height(36)
          .backgroundColor(Color.Transparent)
          .border({ width: 0 })
          .onChange((value: string) => {
            console.info(`[SearchPage] TextInput onChange - value: "${value}"`);
            this.searchText = value;
            this.performSearch();
          })
          .onSubmit(() => {
            console.info(`[SearchPage] TextInput onSubmit - searchText: "${this.searchText}"`);
            // ç«‹å³æ‰§è¡Œæœç´¢,ä¸ç­‰å¾…é˜²æŠ–
            if (this.debounceTimer !== -1) {
              clearTimeout(this.debounceTimer);
              this.debounceTimer = -1;
            }
            this.fetchRecipes(true);
          })
        
        // æ¸…é™¤æŒ‰é’®
        if (this.searchText.length > 0) {
          Button() {
            Text('âœ•')
              .fontSize(18)
              .fontColor('#999999')
          }
          .type(ButtonType.Normal)
          .backgroundColor(Color.Transparent)
          .width(32)
          .height(32)
          .onClick(() => {
            this.searchText = '';
            this.recipes = [];
            this.hasError = false;
          })
        }
      }
      .layoutWeight(1)
      .height(44)
      .backgroundColor('#F5F5F5')
      .borderRadius(22)
      .padding({ left: 12, right: 4 })
      .margin({ right: 12 })
    }
    .width('100%')
    .height(64)
    .padding({ left: 8, right: 8 })
    .backgroundColor(Color.White)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
  }
  
  /**
   * æ„å»ºç©ºçŠ¶æ€
   */
  @Builder
  buildEmptyState() {
    Column({ space: 16 }) {
      Text('ğŸ”')
        .fontSize(64)
        .opacity(0.3)
      
      Text('è¾“å…¥å…³é”®è¯æœç´¢é…æ–¹')
        .fontSize(16)
        .fontColor('#999999')
      
      Text('æœç´¢å»ºè®®:')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ top: 24 })
      
      Column({ space: 8 }) {
        Text('â€¢ è¾“å…¥é…æ–¹åç§°')
          .fontSize(14)
          .fontColor('#999999')
        Text('â€¢ æ”¯æŒæ¨¡ç³Šæœç´¢')
          .fontSize(14)
          .fontColor('#999999')
        Text('â€¢ å®æ—¶æ˜¾ç¤ºç»“æœ')
          .fontSize(14)
          .fontColor('#999999')
      }
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding(32)
  }
  
  /**
   * æ„å»ºåŠ è½½çŠ¶æ€
   */
  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#1890ff')
      
      Text('æœç´¢ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }
  
  /**
   * æ„å»ºé”™è¯¯çŠ¶æ€
   */
  @Builder
  buildErrorState() {
    Column({ space: 16 }) {
      Text('âš ï¸')
        .fontSize(64)
        .opacity(0.3)
      
      Text(this.errorMessage || 'æœç´¢å¤±è´¥')
        .fontSize(14)
        .fontColor('#FF3B30')
        .textAlign(TextAlign.Center)
        .lineHeight(22)
        .padding({ left: 20, right: 20 })
      
      // æç¤ºä¿¡æ¯å¡ç‰‡
      Column({ space: 8 }) {
        Text('ğŸ’¡ æç¤º')
          .fontSize(12)
          .fontColor('#666666')
          .fontWeight(FontWeight.Bold)
        
        Column({ space: 4 }) {
          Text('â€¢ å·²å°è¯•ä½¿ç”¨æœ¬åœ°è¿‡æ»¤æ–¹æ¡ˆ')
            .fontSize(11)
            .fontColor('#999999')
          
          Text('â€¢ ç‚¹å‡»"é‡è¯•"æŒ‰é’®å†æ¬¡å°è¯•')
            .fontSize(11)
            .fontColor('#999999')
          
          Text(`â€¢ æœç´¢è¯: "${this.searchText}"`)
            .fontSize(11)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding({ left: 8, right: 8 })
      }
      .width('90%')
      .padding(12)
      .backgroundColor('#F0F9FF')
      .borderRadius(8)
      .margin({ top: 12 })
      
      Row({ space: 12 }) {
        Button('é‡è¯•')
          .fontSize(14)
          .backgroundColor('#1890ff')
          .borderRadius(20)
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .onClick(() => {
            console.info('[SearchPage] User clicked retry button');
            this.fetchRecipes(true);
          })
        
        Button('æµ‹è¯•è¿æ¥')
          .fontSize(14)
          .backgroundColor('#52C41A')
          .borderRadius(20)
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .onClick(async () => {
            console.info('[SearchPage] User clicked test connection button');
            await this.testAPIConnection();
            promptAction.showToast({ 
              message: 'è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—',
              duration: 2000
            });
          })
      }
      .margin({ top: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding(32)
  }
  
  /**
   * æ„å»ºæ— ç»“æœçŠ¶æ€
   */
  @Builder
  buildNoResultsState() {
    Column({ space: 16 }) {
      Text('ğŸ“­')
        .fontSize(64)
        .opacity(0.3)
      
      Text(`æœªæ‰¾åˆ°"${this.searchText}"ç›¸å…³çš„é…æ–¹`)
        .fontSize(16)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
      
      Text('è¯•è¯•å…¶ä»–å…³é”®è¯å§')
        .fontSize(14)
        .fontColor('#CCCCCC')
        .margin({ top: 8 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding(32)
  }
  
  /**
   * æ„å»ºæœç´¢ç»“æœåˆ—è¡¨
   */
  @Builder
  buildResultsList() {
    Column() {
      // ç»“æœç»Ÿè®¡
      Row() {
        Text(`æ‰¾åˆ° ${this.recipes.length} ä¸ªé…æ–¹`)
          .fontSize(14)
          .fontColor('#666666')
        
        if (this.currentPage < this.totalPages) {
          Text(` (ç¬¬ ${this.currentPage}/${this.totalPages} é¡µ)`)
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      
      // ç»“æœåˆ—è¡¨
      List({ space: 12 }) {
        ForEach(this.recipes, (recipe: Recipe, index: number) => {
          ListItem() {
            this.buildRecipeCard(recipe)
          }
          .onClick(() => {
            this.navigateToDetail(recipe);
          })
          .onAppear(() => {
            // æ»šåŠ¨åˆ°å€’æ•°ç¬¬3ä¸ªæ—¶è§¦å‘åŠ è½½æ›´å¤š
            if (index === this.recipes.length - 3) {
              this.loadMore();
            }
          })
        }, (recipe: Recipe) => recipe.id)
        
        // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
        if (this.isLoading && this.recipes.length > 0) {
          ListItem() {
            Row() {
              LoadingProgress()
                .width(30)
                .height(30)
                .color('#1890ff')
              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#999999')
                .margin({ left: 12 })
            }
            .width('100%')
            .height(60)
            .justifyContent(FlexAlign.Center)
          }
        }
        
        // å·²åŠ è½½å…¨éƒ¨
        if (!this.isLoading && this.currentPage >= this.totalPages && this.recipes.length > 0) {
          ListItem() {
            Text('å·²æ˜¾ç¤ºå…¨éƒ¨ç»“æœ')
              .fontSize(12)
              .fontColor('#CCCCCC')
              .width('100%')
              .textAlign(TextAlign.Center)
              .padding({ top: 16, bottom: 16 })
          }
        }
      }
      .layoutWeight(1)
      .width('100%')
      .padding({ left: 12, right: 12, bottom: 12 })
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
    .layoutWeight(1)
    .width('100%')
  }
  
  /**
   * æ„å»ºé…æ–¹å¡ç‰‡
   */
  @Builder
  buildRecipeCard(recipe: Recipe) {
    Column({ space: 12 }) {
      // æ ‡é¢˜å’Œåˆ›å»ºè€…
      Column({ space: 6 }) {
        Text(recipe.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Row({ space: 12 }) {
          Text(`ğŸ‘¤ ${recipe.createdBy}`)
            .fontSize(13)
            .fontColor('#666666')
          
          Text('|')
            .fontSize(13)
            .fontColor('#DDDDDD')
          
          Text(`${recipe.estimatedAbv.toFixed(1)}% ABV`)
            .fontSize(13)
            .fontColor('#1890ff')
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // åˆ†éš”çº¿
      Divider()
        .color('#F0F0F0')
      
      // åº•éƒ¨ä¿¡æ¯
      Row() {
        // åŸæ–™ä¿¡æ¯
        if (recipe.ingredients && typeof recipe.ingredients === 'string') {
          Text(`ğŸ§ª ${recipe.ingredients.split(',').length} ç§åŸæ–™`)
            .fontSize(12)
            .fontColor('#999999')
        }
        
        Blank()
        
        // äº’åŠ¨ä¿¡æ¯
        Row({ space: 16 }) {
          Row({ space: 4 }) {
            Text('â¤ï¸')
              .fontSize(14)
            Text(recipe.likeCount.toString())
              .fontSize(12)
              .fontColor('#999999')
          }
          
          Row({ space: 4 }) {
            Text('â­')
              .fontSize(14)
            Text(recipe.favoriteCount.toString())
              .fontSize(12)
              .fontColor('#999999')
          }
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }
}
