// CustomRecipePage.ets - è‡ªå®šä¹‰é…æ–¹åˆ›å»ºé¡µé¢
// å‚è€ƒ Swift ç‰ˆæœ¬ CustomRecipeView.swift å®ç°

import { router } from '@kit.ArkUI';
import APIService, { AIGeneratedRecipe, AIIngredient } from '../services/APIService';
import { APIIngredient } from '../common/models/Recipe';
import promptAction from '@ohos.promptAction';

// é…æ–™é¡¹æ¥å£
interface IngredientItem {
  id: string;
  name: string;
  abv?: number;
  unit?: string;
  category?: string;
  volume?: number;
}

// å·²é€‰é…æ–™æ¥å£
interface SelectedIngredient {
  id: string;
  name: string;
  volume: number;
  abv: number;
  unit: string;
  category: string;
}

// æ­¥éª¤æ¥å£
interface StepEntry {
  id: string;
  index: number;
  text: string;
}

// ä¿å­˜é…æ–¹æ—¶çš„é…æ–™æ•°æ®æ¥å£
interface RecipeIngredientData {
  id: string;
  name: string;
  volume: number;
  abv: number;
}

// ä¿å­˜é…æ–¹çš„è¯·æ±‚æ•°æ®æ¥å£
interface CreateRecipeData {
  name: string;
  instructions: string;
  estimatedAbv: number;
  ingredients: RecipeIngredientData[];
}

@Component
export struct CustomRecipePage {
  // åŸºç¡€ä¿¡æ¯
  @State cocktailName: string = '';
  @State cocktailDescription: string = '';
  
  // åˆ†ç±»å’ŒåŸæ–™
  private categoryOrder: string[] = [
    'base_alcohol', 'liqueurs', 'vermouth_wine', 'bitters',
    'juice', 'syrup', 'soda_mixer', 'dairy_cream', 'other'
  ];
  
  private categoryNames: Record<string, string> = {
    'base_alcohol': 'åŸºé…’',
    'liqueurs': 'åŠ›å¨‡é…’/åˆ©å£é…’',
    'vermouth_wine': 'å‘³ç¾æ€/åŠ å¼ºè‘¡è„é…’',
    'bitters': 'è‹¦ç²¾',
    'juice': 'æœæ±',
    'syrup': 'ç³–æµ†',
    'soda_mixer': 'ç¢³é…¸/è°ƒé…é¥®æ–™',
    'dairy_cream': 'å¥¶åˆ¶å“',
    'other': 'å…¶ä»–'
  };
  
  @State currentCategory: string = 'base_alcohol';
  @State ingredientSearch: string = '';
  @State allIngredients: IngredientItem[] = [];
  @State loadingIngredients: boolean = false;
  @State ingredientLoadError: string = '';
  
  // å·²é€‰æ‹©çš„é…æ–™
  @State selectedIngredients: SelectedIngredient[] = [];
  
  // åˆ¶ä½œæ­¥éª¤
  @State steps: StepEntry[] = [{ id: '1', index: 1, text: '' }];
  
  // ABV è®¡ç®—
  @State estimatedAbv: number = 0.0;
  @State abvDescription: string = 'æ— é…’ç²¾æˆ–ä½åº¦é…’ç²¾ï¼Œé€‚åˆä»»ä½•äººé¥®ç”¨';
  
  // ä¿å­˜çŠ¶æ€
  @State isSaving: boolean = false;
  @State saveMessage: string = '';
  
  // AIæ™ºèƒ½è°ƒé…’å¸ˆçŠ¶æ€
  @State showAISection: boolean = true;
  @State aiTasteDescription: string = '';
  @State aiOccasion: string = '';
  @State aiAlcoholStrength: string = '';
  @State isGeneratingAI: boolean = false;
  @State aiError: string = '';
  
  // åœºåˆé€‰é¡¹
  private occasionOptions: string[] = ['æ´¾å¯¹èšä¼š', 'æµªæ¼«çº¦ä¼š', 'å•†åŠ¡ç¤¾äº¤', 'ç‹¬è‡ªæ”¾æ¾', 'èŠ‚æ—¥åº†ç¥', 'å¤æ—¥æ¶ˆæš‘', 'å†¬æ—¥æ¸©æš–'];
  // é…’ç²¾å¼ºåº¦é€‰é¡¹
  private strengthOptions: string[] = ['æ— é…’ç²¾', 'ä½åº¦(5%ä»¥ä¸‹)', 'ä¸­åº¦(5-15%)', 'ä¸­é«˜åº¦(15-25%)', 'é«˜åº¦(25%ä»¥ä¸Š)'];
  
  aboutToAppear() {
    this.loadIngredients();
  }
  
  /**
   * åŠ è½½åŸæ–™åˆ—è¡¨
   */
  private async loadIngredients() {
    if (this.loadingIngredients) return;
    
    this.loadingIngredients = true;
    this.ingredientLoadError = '';
    
    try {
      const apiService = APIService.getInstance();
      const result = await apiService.fetchCustomIngredients();
      
      // è§£æåŸæ–™æ•°æ®
      const ingredients: IngredientItem[] = [];
      const ingredientsField: ESObject = Reflect.get(result, 'ingredients') as ESObject;
      if (ingredientsField) {
        const cats: ESObject[] = ingredientsField as ESObject[];
        cats.forEach((cat: ESObject) => {
          const items: ESObject[] = Reflect.get(cat, 'items') as ESObject[];
          const category: string = Reflect.get(cat, 'category') as string;
          
          if (items) {
            items.forEach((item: ESObject) => {
              const ingredientId: string = Reflect.get(item, 'id') as string;
              const ingredientName: string = Reflect.get(item, 'name') as string;
              const ingredientAbv: number = Reflect.get(item, 'abv') as number;
              const ingredientUnit: string = Reflect.get(item, 'unit') as string;
              
              ingredients.push({
                id: ingredientId,
                name: ingredientName,
                abv: ingredientAbv,
                unit: ingredientUnit,
                category: category
              });
            });
          }
        });
      }
      
      this.allIngredients = ingredients;
      console.info(`[CustomRecipe] åŠ è½½äº† ${ingredients.length} ä¸ªé…æ–™`);
      
    } catch (error) {
      console.error('[CustomRecipe] åŠ è½½é…æ–™å¤±è´¥:', error);
      this.ingredientLoadError = 'åŠ è½½é…æ–™å¤±è´¥';
    } finally {
      this.loadingIngredients = false;
    }
  }
  
  /**
   * AIç”Ÿæˆé…æ–¹
   */
  private async generateAIRecipe() {
    if (this.aiTasteDescription.trim().length === 0) {
      this.aiError = 'è¯·è¾“å…¥å£å‘³æè¿°';
      return;
    }
    
    this.isGeneratingAI = true;
    this.aiError = '';
    
    try {
      const apiService = APIService.getInstance();
      const result = await apiService.generateAIRecipe(
        this.aiTasteDescription,
        this.aiOccasion.length > 0 ? this.aiOccasion : undefined,
        this.aiAlcoholStrength.length > 0 ? this.aiAlcoholStrength : undefined
      );
      
      // å¡«å……ç”Ÿæˆçš„é…æ–¹åˆ°è¡¨å•
      this.applyAIRecipe(result);
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      promptAction.showToast({
        message: result.isDemo ? 'AIé…æ–¹ç”ŸæˆæˆåŠŸ(æ¼”ç¤ºæ¨¡å¼)' : 'AIé…æ–¹ç”ŸæˆæˆåŠŸï¼',
        duration: 2000
      });
      
      // æ”¶èµ·AIåŒºåŸŸ
      this.showAISection = false;
      
    } catch (error) {
      console.error('[CustomRecipe] AIç”Ÿæˆå¤±è´¥:', error);
      if (error instanceof Error) {
        this.aiError = error.message;
      } else {
        this.aiError = 'AIç”Ÿæˆé…æ–¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      }
    } finally {
      this.isGeneratingAI = false;
    }
  }
  
  /**
   * å°†AIç”Ÿæˆçš„é…æ–¹åº”ç”¨åˆ°è¡¨å•
   */
  private applyAIRecipe(recipe: AIGeneratedRecipe) {
    try {
      // å®‰å…¨æ£€æŸ¥
      if (!recipe) {
        console.error('[CustomRecipe] é…æ–¹æ•°æ®ä¸ºç©º');
        this.aiError = 'é…æ–¹æ•°æ®ä¸ºç©º';
        return;
      }
      
      // å¡«å……åç§°å’Œæè¿°
      this.cocktailName = recipe.name || 'AIç‰¹è°ƒ';
      this.cocktailDescription = recipe.description || '';
      
      // æ¸…ç©ºå¹¶å¡«å……é…æ–™
      this.selectedIngredients = [];
      if (recipe.ingredients && Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0) {
        const timestamp = Date.now();
        for (let i = 0; i < recipe.ingredients.length; i++) {
          const ing = recipe.ingredients[i];
          if (ing && ing.name) {
            this.selectedIngredients.push({
              id: `ai_${i}_${timestamp}`,
              name: ing.name,
              volume: ing.volume || 30,
              abv: ing.abv || 0,
              unit: 'æ¯«å‡',
              category: ing.category || 'other'
            });
          }
        }
      }
      
      // æ¸…ç©ºå¹¶å¡«å……æ­¥éª¤
      this.steps = [];
      if (recipe.steps && Array.isArray(recipe.steps) && recipe.steps.length > 0) {
        const timestamp = Date.now();
        for (let i = 0; i < recipe.steps.length; i++) {
          const step = recipe.steps[i];
          if (step && typeof step === 'string') {
            this.steps.push({
              id: `step_${i}_${timestamp}`,
              index: i + 1,
              text: step
            });
          }
        }
      }
      
      // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ­¥éª¤
      if (this.steps.length === 0) {
        this.steps = [{ id: '1', index: 1, text: '' }];
      }
      
      // é‡æ–°è®¡ç®—ABV
      this.recalculateAbv();
      
      console.info('[CustomRecipe] é…æ–¹å·²åº”ç”¨:', this.cocktailName);
    } catch (error) {
      console.error('[CustomRecipe] åº”ç”¨é…æ–¹å¤±è´¥:', error);
      this.aiError = 'åº”ç”¨é…æ–¹å¤±è´¥';
    }
  }
  
  /**
   * è·å–å½“å‰åˆ†ç±»çš„é…æ–™(è¿‡æ»¤å)
   */
  private getFilteredIngredients(): IngredientItem[] {
    let items = this.allIngredients.filter(item => item.category === this.currentCategory);
    
    if (this.ingredientSearch.trim().length > 0) {
      const query = this.ingredientSearch.toLowerCase();
      items = items.filter(item => 
        item.name.toLowerCase().includes(query) || 
        item.id.toLowerCase().includes(query)
      );
    }
    
    return items;
  }
  
  /**
   * è·å–æŒ‡å®šåˆ†ç±»çš„å·²é€‰é…æ–™
   */
  private getSelectedByCategory(category: string): SelectedIngredient[] {
    return this.selectedIngredients.filter(ing => ing.category === category);
  }
  
  /**
   * åˆ‡æ¢é…æ–™é€‰æ‹©
   */
  private toggleIngredient(item: IngredientItem) {
    const index = this.selectedIngredients.findIndex(ing => ing.id === item.id);
    
    if (index >= 0) {
      // ç§»é™¤
      this.selectedIngredients.splice(index, 1);
    } else {
      // æ·»åŠ 
      const defaultVolume = this.getDefaultVolume(item);
      this.selectedIngredients.push({
        id: item.id,
        name: item.name,
        volume: defaultVolume,
        abv: item.abv || 0,
        unit: item.unit || 'æ¯«å‡',
        category: item.category || 'other'
      });
    }
    
    this.recalculateAbv();
  }
  
  /**
   * è·å–é»˜è®¤ç”¨é‡
   */
  private getDefaultVolume(item: IngredientItem): number {
    const unit = (item.unit || '').toLowerCase();
    if (unit.includes('æ»´') || unit.includes('drop')) return 3;
    if (unit.includes('ç‰‡') || unit.includes('slice')) return 1;
    if (unit.includes('ä¸ª') || unit.includes('piece')) return 1;
    return 30; // é»˜è®¤30ml
  }
  
  /**
   * åˆ¤æ–­é…æ–™æ˜¯å¦å·²é€‰
   */
  private isIngredientSelected(id: string): boolean {
    return this.selectedIngredients.some(ing => ing.id === id);
  }
  
  /**
   * æ›´æ–°é…æ–™ç”¨é‡
   */
  private updateIngredientVolume(id: string, volume: number) {
    const ing = this.selectedIngredients.find(i => i.id === id);
    if (ing) {
      ing.volume = volume;
      this.recalculateAbv();
    }
  }
  
  /**
   * ç§»é™¤é…æ–™
   */
  private removeIngredient(id: string) {
    const index = this.selectedIngredients.findIndex(ing => ing.id === id);
    if (index >= 0) {
      this.selectedIngredients.splice(index, 1);
      this.recalculateAbv();
    }
  }
  
  /**
   * é‡æ–°è®¡ç®—ABV
   */
  private recalculateAbv() {
    let totalAlcohol = 0;
    let totalVolume = 0;
    
    this.selectedIngredients.forEach(ing => {
      // åªè®¡ç®—æ¶²ä½“(æœ‰mlå•ä½çš„)
      if (ing.unit.includes('æ¯«å‡') || ing.unit.toLowerCase().includes('ml')) {
        totalVolume += ing.volume;
        totalAlcohol += (ing.volume * ing.abv / 100);
      }
    });
    
    if (totalVolume > 0) {
      this.estimatedAbv = (totalAlcohol / totalVolume) * 100;
    } else {
      this.estimatedAbv = 0;
    }
    
    // æ›´æ–°æè¿°
    if (this.estimatedAbv < 5) {
      this.abvDescription = 'æ— é…’ç²¾æˆ–ä½åº¦é…’ç²¾ï¼Œé€‚åˆä»»ä½•äººé¥®ç”¨';
    } else if (this.estimatedAbv < 15) {
      this.abvDescription = 'ä½åº¦é…’ç²¾é¥®å“ï¼Œå£æ„Ÿæ¸©å’Œ';
    } else if (this.estimatedAbv < 25) {
      this.abvDescription = 'ä¸­åº¦é…’ç²¾ï¼Œç»å…¸é¸¡å°¾é…’å¼ºåº¦';
    } else if (this.estimatedAbv < 35) {
      this.abvDescription = 'è¾ƒé«˜é…’ç²¾åº¦ï¼Œè¯·é€‚é‡é¥®ç”¨';
    } else {
      this.abvDescription = 'é«˜åº¦é…’ç²¾é¥®å“ï¼ŒåŠ¡å¿…è°¨æ…';
    }
  }
  
  /**
   * æ·»åŠ æ­¥éª¤
   */
  private addStep() {
    const newIndex = this.steps.length + 1;
    this.steps.push({
      id: Date.now().toString(),
      index: newIndex,
      text: ''
    });
  }
  
  /**
   * ç§»é™¤æ­¥éª¤
   */
  private removeStep(id: string) {
    if (this.steps.length <= 1) return;
    
    const index = this.steps.findIndex(s => s.id === id);
    if (index >= 0) {
      this.steps.splice(index, 1);
      // é‡æ–°ç¼–å·
      this.steps.forEach((step, idx) => {
        step.index = idx + 1;
      });
    }
  }
  
  /**
   * æ›´æ–°æ­¥éª¤æ–‡æœ¬
   */
  private updateStepText(id: string, text: string) {
    const step = this.steps.find(s => s.id === id);
    if (step) {
      step.text = text;
    }
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥ä¿å­˜
   */
  private canSave(): boolean {
    return this.cocktailName.trim().length > 0 && 
           this.selectedIngredients.length > 0 &&
           !this.isSaving;
  }
  
  /**
   * ä¿å­˜é…æ–¹
   */
  private async saveCocktail() {
    if (!this.canSave()) {
      promptAction.showToast({ message: 'è¯·å¡«å†™åç§°å¹¶é€‰æ‹©é…æ–™' });
      return;
    }
    
    this.isSaving = true;
    
    try {
      const apiService = APIService.getInstance();
      
      // æ„å»ºé…æ–™æ•°ç»„
      const ingredients: RecipeIngredientData[] = this.selectedIngredients.map(ing => {
        const data: RecipeIngredientData = {
          id: ing.id,
          name: ing.name,
          volume: ing.volume,
          abv: ing.abv
        };
        return data;
      });
      
      // æ„å»ºæ­¥éª¤å­—ç¬¦ä¸²
      const instructions = this.steps
        .filter(s => s.text.trim().length > 0)
        .map(s => `${s.index}. ${s.text}`)
        .join('\n');
      
      // è°ƒç”¨APIä¿å­˜
      const recipeData: CreateRecipeData = {
        name: this.cocktailName,
        instructions: instructions,
        estimatedAbv: this.estimatedAbv,
        ingredients: ingredients
      };
      const result = await apiService.createRecipe(recipeData);
      
      promptAction.showToast({ message: 'é…æ–¹ä¿å­˜æˆåŠŸ!' });
      
      // æ¸…ç©ºè¡¨å•
      this.cocktailName = '';
      this.cocktailDescription = '';
      this.selectedIngredients = [];
      this.steps = [{ id: '1', index: 1, text: '' }];
      this.estimatedAbv = 0;
      
      // å»¶è¿Ÿåå®‰å…¨è¿”å›
      setTimeout(() => {
        try {
          router.back();
        } catch (e) {
          console.error('[CustomRecipe] è¿”å›å¤±è´¥:', e);
        }
      }, 1500);
      
    } catch (error) {
      console.error('[CustomRecipe] ä¿å­˜å¤±è´¥:', error);
      const message = error instanceof Error ? error.message : 'ä¿å­˜å¤±è´¥';
      promptAction.showToast({ message: message });
    } finally {
      this.isSaving = false;
    }
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(44)
        .height(44)
        .onClick(() => {
          router.back();
        })
        
        Text('è‡ªå®šä¹‰é…æ–¹')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½
        Row().width(44).height(44)
      }
      .width('100%')
      .height(56)
      .padding({ left: 8, right: 16 })
      
      // å†…å®¹åŒºåŸŸ - æ»šåŠ¨è§†å›¾
      Scroll() {
        Column({ space: 24 }) {
          // AIæ™ºèƒ½è°ƒé…’å¸ˆ
          this.buildAISection()
          
          // åŸºæœ¬ä¿¡æ¯
          this.buildBasicInfoSection()
          
          // åŸæ–™é€‰æ‹©
          this.buildIngredientSection()
          
          // ABVè®¡ç®—
          this.buildAbvSection()
          
          // åˆ¶ä½œæ­¥éª¤
          this.buildStepsSection()
          
          // ä¿å­˜æŒ‰é’®
          this.buildSaveButton()
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .width('100%')
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  
  /**
   * AIæ™ºèƒ½è°ƒé…’å¸ˆåŒºåŸŸ
   */
  @Builder
  buildAISection() {
    Column({ space: 16 }) {
      // æ ‡é¢˜æ  - å¯å±•å¼€/æ”¶èµ·
      Row() {
        Row({ space: 8 }) {
          Text('ğŸ¸')
            .fontSize(20)
          Text('AIæ™ºèƒ½è°ƒé…’å¸ˆ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890ff')
        }
        
        Blank()
        
        Button() {
          Text(this.showAISection ? 'æ”¶èµ·' : 'å±•å¼€')
            .fontSize(13)
            .fontColor('#1890ff')
        }
        .type(ButtonType.Normal)
        .backgroundColor('rgba(24, 144, 255, 0.1)')
        .borderRadius(12)
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .onClick(() => {
          this.showAISection = !this.showAISection;
        })
      }
      .width('100%')
      
      // è¯´æ˜æ–‡å­—
      Text('æ²¡æœ‰çµæ„Ÿï¼Ÿæè¿°æ‚¨æƒ³è¦çš„å£å‘³ï¼Œè®©AIä¸ºæ‚¨é‡èº«å®šåˆ¶é¸¡å°¾é…’é…æ–¹')
        .fontSize(13)
        .fontColor('#666666')
      
      if (this.showAISection) {
        Column({ space: 14 }) {
          // å£å‘³æè¿°
          Column({ space: 6 }) {
            Row({ space: 4 }) {
              Text('ğŸ¯')
                .fontSize(14)
              Text('å£å‘³æè¿°')
                .fontSize(14)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
            }
            
            TextArea({ 
              placeholder: 'ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€æ¬¾æ¸…çˆ½çš„å¤æ—¥é¸¡å°¾é…’ï¼Œå¸¦æœ‰æŸ‘æ©˜é¦™å‘³ï¼Œä¸è¦å¤ªç”œï¼Œé…’ç²¾åº¦é€‚ä¸­...', 
              text: this.aiTasteDescription 
            })
              .onChange((value: string) => {
                this.aiTasteDescription = value;
              })
              .backgroundColor(Color.White)
              .borderRadius(8)
              .height(100)
          }
          .alignItems(HorizontalAlign.Start)
          .width('100%')
          
          // å¯é€‰é¡¹ - åœºåˆå’Œé…’ç²¾å¼ºåº¦
          Row({ space: 12 }) {
            // é€‚ç”¨åœºåˆ
            Column({ space: 6 }) {
              Row({ space: 4 }) {
                Text('ğŸ‰')
                  .fontSize(14)
                Text('é€‚ç”¨åœºåˆ')
                  .fontSize(13)
                  .fontColor('#666666')
              }
              
              Select(this.occasionOptions.map(opt => ({ value: opt } as SelectOption)))
                .selected(this.occasionOptions.indexOf(this.aiOccasion))
                .value(this.aiOccasion.length > 0 ? this.aiOccasion : 'è¯·é€‰æ‹©ï¼ˆå¯é€‰ï¼‰')
                .font({ size: 14 })
                .fontColor('#333333')
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onSelect((index: number) => {
                  this.aiOccasion = this.occasionOptions[index];
                })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            
            // é…’ç²¾å¼ºåº¦
            Column({ space: 6 }) {
              Row({ space: 4 }) {
                Text('ğŸ’ª')
                  .fontSize(14)
                Text('é…’ç²¾å¼ºåº¦')
                  .fontSize(13)
                  .fontColor('#666666')
              }
              
              Select(this.strengthOptions.map(opt => ({ value: opt } as SelectOption)))
                .selected(this.strengthOptions.indexOf(this.aiAlcoholStrength))
                .value(this.aiAlcoholStrength.length > 0 ? this.aiAlcoholStrength : 'è¯·é€‰æ‹©ï¼ˆå¯é€‰ï¼‰')
                .font({ size: 14 })
                .fontColor('#333333')
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onSelect((index: number) => {
                  this.aiAlcoholStrength = this.strengthOptions[index];
                })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
          }
          .width('100%')
          
          // é”™è¯¯æç¤º
          if (this.aiError.length > 0) {
            Text(this.aiError)
              .fontSize(13)
              .fontColor('#FF3B30')
          }
          
          // ç”ŸæˆæŒ‰é’®
          Button() {
            if (this.isGeneratingAI) {
              Row({ space: 8 }) {
                LoadingProgress()
                  .width(20)
                  .height(20)
                  .color(Color.White)
                Text('AIç”Ÿæˆä¸­...')
                  .fontSize(16)
                  .fontColor(Color.White)
              }
            } else {
              Row({ space: 8 }) {
                Text('ğŸ¤–')
                  .fontSize(18)
                Text('ç”ŸæˆAIé…æ–¹')
                  .fontSize(16)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Medium)
              }
            }
          }
          .type(ButtonType.Normal)
          .backgroundColor(this.isGeneratingAI ? '#999999' : '#667eea')
          .borderRadius(25)
          .width('100%')
          .height(50)
          .enabled(!this.isGeneratingAI)
          .onClick(() => {
            this.generateAIRecipe();
          })
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 2 })
  }
  
  /**
   * åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
   */
  @Builder
  buildBasicInfoSection() {
    Column({ space: 12 }) {
      Text('åŸºæœ¬ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
      
      Column({ space: 10 }) {
        Column({ space: 6 }) {
          Text('åç§°')
            .fontSize(14)
            .fontColor('#666666')
          
          TextInput({ placeholder: 'è¾“å…¥é¸¡å°¾é…’åç§°', text: this.cocktailName })
            .onChange((value: string) => {
              this.cocktailName = value;
            })
            .backgroundColor(Color.White)
            .borderRadius(8)
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        
        Column({ space: 6 }) {
          Text('æè¿°(å¯é€‰)')
            .fontSize(14)
            .fontColor('#666666')
          
          TextArea({ placeholder: 'å£å‘³/é£æ ¼ç®€ä»‹', text: this.cocktailDescription })
            .onChange((value: string) => {
              this.cocktailDescription = value;
            })
            .backgroundColor(Color.White)
            .borderRadius(8)
            .height(80)
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
  
  /**
   * åŸæ–™é€‰æ‹©åŒºåŸŸ
   */
  @Builder
  buildIngredientSection() {
    Column({ space: 12 }) {
      Text('åŸæ–™é€‰æ‹©')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
      
      Column({ space: 12 }) {
        // åˆ†ç±»æ ‡ç­¾
        Scroll() {
          Row({ space: 10 }) {
            ForEach(this.categoryOrder, (cat: string) => {
              Button() {
                Text(this.categoryNames[cat] || cat)
                  .fontSize(13)
                  .fontColor(this.currentCategory === cat ? Color.White : '#1890ff')
              }
              .type(ButtonType.Capsule)
              .backgroundColor(this.currentCategory === cat ? '#1890ff' : 'rgba(24, 144, 255, 0.15)')
              .padding({ left: 14, right: 14, top: 8, bottom: 8 })
              .onClick(() => {
                this.currentCategory = cat;
              })
            }, (cat: string) => cat)
          }
          .padding({ top: 4, bottom: 4 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .width('100%')
        
        // æœç´¢æ¡†
        Search({ placeholder: 'æœç´¢å½“å‰åˆ†ç±»åŸæ–™', value: this.ingredientSearch })
          .onChange((value: string) => {
            this.ingredientSearch = value;
          })
          .backgroundColor(Color.White)
        
        // é…æ–™ç½‘æ ¼
        if (this.loadingIngredients) {
          Row() {
            LoadingProgress()
              .width(30)
              .height(30)
              .color('#1890ff')
            Text('åŠ è½½é…æ–™...')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ left: 10 })
          }
          .padding(20)
          .justifyContent(FlexAlign.Center)
        } else if (this.ingredientLoadError) {
          Text(this.ingredientLoadError)
            .fontSize(14)
            .fontColor('#FF3B30')
            .padding(20)
        } else {
          this.buildIngredientGrid()
        }
        
        // å·²é€‰é…æ–™åˆ—è¡¨
        if (this.selectedIngredients.length > 0) {
          this.buildSelectedIngredientsList()
        }
      }
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
  
  /**
   * é…æ–™ç½‘æ ¼
   */
  @Builder
  buildIngredientGrid() {
    if (this.getFilteredIngredients().length === 0) {
      Text('æ— åŒ¹é…é…æ–™')
        .fontSize(14)
        .fontColor('#999999')
        .padding(20)
        .width('100%')
        .textAlign(TextAlign.Center)
    } else {
      GridRow({ columns: 3, gutter: 10 }) {
        ForEach(this.getFilteredIngredients(), (item: IngredientItem) => {
          GridCol() {
            this.buildIngredientCard(item)
          }
        }, (item: IngredientItem) => item.id)
      }
    }
  }
  
  /**
   * é…æ–™å¡ç‰‡
   */
  @Builder
  buildIngredientCard(item: IngredientItem) {
    Column({ space: 6 }) {
      Text(item.name)
        .fontSize(13)
        .fontColor(this.isIngredientSelected(item.id) ? Color.White : '#333333')
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')
      
      if (item.abv && item.abv > 0) {
        Text(`${item.abv}%`)
          .fontSize(11)
          .fontColor(this.isIngredientSelected(item.id) ? 'rgba(255,255,255,0.8)' : '#999999')
      }
    }
    .width('100%')
    .padding(10)
    .backgroundColor(this.isIngredientSelected(item.id) ? '#1890ff' : '#F5F5F5')
    .borderRadius(8)
    .border({
      width: this.isIngredientSelected(item.id) ? 2 : 1,
      color: this.isIngredientSelected(item.id) ? '#1890ff' : '#E8E8E8'
    })
    .onClick(() => {
      this.toggleIngredient(item);
    })
  }
  
  /**
   * å·²é€‰é…æ–™åˆ—è¡¨
   */
  @Builder
  buildSelectedIngredientsList() {
    Column({ space: 12 }) {
      Text('å·²é€‰é…æ–™')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ top: 12 })
      
      // æŒ‰åˆ†ç±»åˆ†ç»„æ˜¾ç¤º
      ForEach(this.categoryOrder, (cat: string) => {
        if (this.getSelectedByCategory(cat).length > 0) {
          Column({ space: 8 }) {
            Text(this.categoryNames[cat] || cat)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#666666')
            
            ForEach(this.getSelectedByCategory(cat), (ing: SelectedIngredient) => {
              this.buildSelectedIngredientRow(ing)
            }, (ing: SelectedIngredient) => ing.id)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
        }
      }, (cat: string) => cat)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
  
  /**
   * å·²é€‰é…æ–™è¡Œ
   */
  @Builder
  buildSelectedIngredientRow(ing: SelectedIngredient) {
    Row({ space: 10 }) {
      // é…æ–™åç§°
      Text(ing.name)
        .fontSize(14)
        .fontColor('#333333')
        .layoutWeight(1)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
      
      // ç”¨é‡è¾“å…¥
      TextInput({ text: ing.volume.toString() })
        .type(InputType.Number)
        .width(70)
        .height(36)
        .fontSize(13)
        .backgroundColor('#F5F5F5')
        .borderRadius(6)
        .onChange((value: string) => {
          const num = parseFloat(value);
          if (!isNaN(num) && num >= 0) {
            this.updateIngredientVolume(ing.id, num);
          }
        })
      
      Text(ing.unit)
        .fontSize(12)
        .fontColor('#999999')
        .width(40)
      
      // åˆ é™¤æŒ‰é’®
      Button() {
        Text('âœ•')
          .fontSize(16)
          .fontColor('#FF3B30')
      }
      .type(ButtonType.Normal)
      .backgroundColor(Color.Transparent)
      .width(32)
      .height(32)
      .onClick(() => {
        this.removeIngredient(ing.id);
      })
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FAFAFA')
    .borderRadius(8)
  }
  
  /**
   * ABVè®¡ç®—åŒºåŸŸ
   */
  @Builder
  buildAbvSection() {
    Column({ space: 12 }) {
      Text('é…’ç²¾åº¦è®¡ç®—')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
      
      Row({ space: 16 }) {
        // ABVæ•°å€¼æ˜¾ç¤º
        Column({ space: 4 }) {
          Text(this.estimatedAbv.toFixed(1))
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890ff')
          
          Text('% ABV')
            .fontSize(14)
            .fontColor('#999999')
        }
        
        Divider()
          .vertical(true)
          .height(60)
          .color('#E8E8E8')
        
        // æè¿°
        Text(this.abvDescription)
          .fontSize(14)
          .fontColor('#666666')
          .layoutWeight(1)
          .maxLines(2)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
  
  /**
   * åˆ¶ä½œæ­¥éª¤åŒºåŸŸ
   */
  @Builder
  buildStepsSection() {
    Column({ space: 12 }) {
      Text('åˆ¶ä½œæ­¥éª¤')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
      
      Column({ space: 10 }) {
        ForEach(this.steps, (step: StepEntry) => {
          Row({ space: 10 }) {
            Text(`${step.index}.`)
              .fontSize(16)
              .fontColor('#1890ff')
              .fontWeight(FontWeight.Medium)
              .width(30)
              .textAlign(TextAlign.End)
            
            TextArea({ placeholder: 'æ­¥éª¤å†…å®¹', text: step.text })
              .onChange((value: string) => {
                this.updateStepText(step.id, value);
              })
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .layoutWeight(1)
              .height(60)
            
            if (this.steps.length > 1) {
              Button() {
                Text('âˆ’')
                  .fontSize(20)
                  .fontColor('#FF3B30')
              }
              .type(ButtonType.Circle)
              .backgroundColor('rgba(255,59,48,0.1)')
              .width(36)
              .height(36)
              .onClick(() => {
                this.removeStep(step.id);
              })
            }
          }
          .width('100%')
          .alignItems(VerticalAlign.Top)
        }, (step: StepEntry) => step.id)
        
        // æ·»åŠ æ­¥éª¤æŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Text('+')
              .fontSize(18)
            Text('æ·»åŠ æ­¥éª¤')
              .fontSize(14)
          }
        }
        .type(ButtonType.Normal)
        .backgroundColor('rgba(24, 144, 255, 0.15)')
        .fontColor('#1890ff')
        .borderRadius(8)
        .padding({ left: 20, right: 20, top: 10, bottom: 10 })
        .onClick(() => {
          this.addStep();
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
  
  /**
   * ä¿å­˜æŒ‰é’®
   */
  @Builder
  buildSaveButton() {
    Button() {
      Row({ space: 10 }) {
        if (this.isSaving) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(Color.White)
        }
        
        Text(this.isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜é…æ–¹')
          .fontSize(16)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
    }
    .type(ButtonType.Normal)
    .backgroundColor(this.canSave() ? '#52c41a' : '#D8D8D8')
    .width('100%')
    .height(50)
    .borderRadius(12)
    .enabled(this.canSave())
    .onClick(() => {
      this.saveCocktail();
    })
  }
}
