// RecipeDetailPage.ets - é…æ–¹è¯¦æƒ…é¡µé¢(ç‹¬ç«‹é¡µé¢ç‰ˆæœ¬)
// æ ¹æ® server.js é‡å†™,åŒ…å«å®Œæ•´çš„é…æ–¹è¯¦æƒ…åŠŸèƒ½
// å‚è€ƒ: server.js ä¸­çš„ /api/recipes/:id, /api/recipes/:id/comments, 
//      /api/recipes/:id/like, /api/recipes/:id/favorite, /api/recipes/:id/interactions

import APIService from '../services/APIService';
import { Recipe, Ingredient } from '../models/Recipe';
import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';

/**
 * è¯„è®ºæ¥å£
 * å¯¹åº” server.js ä¸­ comment è¡¨ç»“æ„
 */
interface Comment {
  id: string;
  user_id: string;
  username: string;
  text: string;
  timestamp: string;
}

/**
 * è·¯ç”±å‚æ•°æ¥å£
 */
interface RouterParams {
  recipeId: string;
}

/**
 * äº¤äº’çŠ¶æ€æ¥å£
 * å¯¹åº” server.js ä¸­ /api/recipes/:id/interactions è¿”å›ç»“æ„
 */
interface InteractionStatus {
  likeCount: number;
  favoriteCount: number;
  isLiked: boolean;
  isFavorited: boolean;
}

/**
 * é…æ–¹è¯¦æƒ…æ¥å£
 * å¯¹åº” server.js ä¸­ /api/recipes/:id è¿”å›ç»“æ„
 */
interface RecipeDetail {
  id: string;
  name: string;
  createdBy: string;
  instructions: string;
  estimatedAbv: number;
  likeCount: number;
  favoriteCount: number;
  ingredients: Array<Ingredient>;
  image?: string;       // âœ… è¡¥å……å›¾ç‰‡å­—æ®µ
  description?: string; // âœ… è¡¥å……æè¿°å­—æ®µ
}

@Entry
@Component
struct RecipeDetailPage {
  @State recipeId: string = '';
  private scroller: Scroller = new Scroller();
  
  // é…æ–¹æ•°æ®
  @State recipe?: RecipeDetail = undefined;
  @State ingredients: Array<Ingredient> = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  
  // äº¤äº’çŠ¶æ€ (å¯¹åº” server.js ä¸­çš„ likes å’Œ favorites è¡¨)
  @State likeCount: number = 0;
  @State favoriteCount: number = 0;
  @State isLiked: boolean = false;
  @State isFavorited: boolean = false;
  @State isLoadingInteraction: boolean = false;
  
  // è¯„è®ºç›¸å…³ (å¯¹åº” server.js ä¸­çš„ comment è¡¨)
  @State comments: Array<Comment> = [];
  @State showComments: boolean = false;
  @State isLoadingComments: boolean = false;
  @State newCommentText: string = '';
  @State isSubmittingComment: boolean = false;
  @State commentError: string = '';
  
  // ç™»å½•çŠ¶æ€
  @State isLoggedIn: boolean = false;
  
  // AIå£å‘³åˆ†æç›¸å…³çŠ¶æ€
  @State isAnalyzing: boolean = false;
  @State showAIAnalysis: boolean = false;
  @State aiAnalysisText: string = '';
  private readonly DEFAULT_WINE_IMAGE: string = '/uploads/cocktails/jiu.jpg';

  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°è·å– recipeId
    const params = router.getParams() as RouterParams;
    if (params && params.recipeId) {
      this.recipeId = params.recipeId;
      console.info(`[RecipeDetailPage] aboutToAppear - recipeId from router: ${this.recipeId}`);
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      this.isLoggedIn = APIService.getInstance().isLoggedIn;
      
      // åŠ è½½é…æ–¹è¯¦æƒ…
      this.loadRecipeDetail();
    } else {
      console.error('[RecipeDetailPage] recipeId not found in router params');
      this.errorMessage = 'é…æ–¹IDä¸èƒ½ä¸ºç©º';
      this.isLoading = false;
    }
  }
  
  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private goBack() {
    router.back();
  }

  /**
   * å®‰å…¨åœ°è§£ææ•°å€¼,å¤„ç†å„ç§å¯èƒ½çš„è¾“å…¥ç±»å‹
   */
  private parseNumber(value: string | number | object | null): number {
    if (value === null || value === undefined) {
      return 0;
    }
    if (typeof value === 'number') {
      return value;
    }
    if (typeof value === 'string') {
      const parsed = parseFloat(value);
      return isNaN(parsed) ? 0 : parsed;
    }
    // å¯¹äºå¯¹è±¡ç±»å‹(å¦‚Decimal),å°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²å†è§£æ
    const parsed = parseFloat(String(value));
    return isNaN(parsed) ? 0 : parsed;
  }

  /**
   * åŠ è½½é…æ–¹è¯¦æƒ…
   * å¯¹åº” server.js: GET /api/recipes/:id
   * è¿”å›: { id, name, instructions, estimatedAbv, createdBy, likeCount, favoriteCount, ingredients[] }
   */
  private async loadRecipeDetail() {
    console.info(`[RecipeDetailPage] loadRecipeDetail start - recipeId: ${this.recipeId}`);
    
    if (!this.recipeId) {
      this.errorMessage = 'é…æ–¹IDä¸èƒ½ä¸ºç©º';
      this.isLoading = false;
      return;
    }
    
    this.isLoading = true;
    this.errorMessage = '';
    
    try {
      console.info(`[RecipeDetailPage] fetching recipe detail for id: ${this.recipeId}`);
      const detail: object = await APIService.getInstance().fetchRecipeDetail(this.recipeId);
      console.info(`[RecipeDetailPage] recipe detail fetched successfully`);
      
      // è§£æé…æ–¹æ•°æ®
      const estimatedAbvValue = Reflect.get(detail, 'estimatedAbv') as string | number | object | null;
      const likeCountValue = Reflect.get(detail, 'likeCount') as string | number | object | null;
      const favoriteCountValue = Reflect.get(detail, 'favoriteCount') as string | number | object | null;
      
      console.info(`[RecipeDetailPage] Parsing values - estimatedAbv type: ${typeof estimatedAbvValue}, value: ${estimatedAbvValue}`);
      console.info(`[RecipeDetailPage] likeCount type: ${typeof likeCountValue}, value: ${likeCountValue}`);
      console.info(`[RecipeDetailPage] favoriteCount type: ${typeof favoriteCountValue}, value: ${favoriteCountValue}`);
      
      this.recipe = {
        id: Reflect.get(detail, 'id') as string,
        name: Reflect.get(detail, 'name') as string,
        createdBy: Reflect.get(detail, 'createdBy') as string,
        instructions: Reflect.get(detail, 'instructions') as string,
        estimatedAbv: this.parseNumber(estimatedAbvValue),
        likeCount: this.parseNumber(likeCountValue),
        favoriteCount: this.parseNumber(favoriteCountValue),
        image: Reflect.get(detail, 'image') as string,       // âœ… è§£æå›¾ç‰‡
        description: Reflect.get(detail, 'description') as string, // âœ… è§£ææè¿°
        ingredients: []
      };
      
      console.info(`[RecipeDetailPage] Parsed recipe - estimatedAbv: ${this.recipe.estimatedAbv}, likeCount: ${this.recipe.likeCount}`);
      
      // è§£æåŸæ–™åˆ—è¡¨
      const ingredientsData = Reflect.get(detail, 'ingredients') as Array<object>;
      if (ingredientsData && Array.isArray(ingredientsData)) {
        this.ingredients = ingredientsData.map((ing: object): Ingredient => {
          const volumeValue = Reflect.get(ing, 'volume') as string | number | object | null;
          const abvValue = Reflect.get(ing, 'abv') as string | number | object | null;
          
          const ingredient: Ingredient = {
            id: Reflect.get(ing, 'id') as string,
            cocktail_id: Reflect.get(ing, 'cocktail_id') as string,
            name: Reflect.get(ing, 'name') as string,
            volume: this.parseNumber(volumeValue),
            abv: this.parseNumber(abvValue)
          };
          return ingredient;
        });
        this.recipe.ingredients = this.ingredients;
      }
      
      // åˆå§‹åŒ–äº¤äº’è®¡æ•°
      this.likeCount = this.recipe.likeCount || 0;
      this.favoriteCount = this.recipe.favoriteCount || 0;
      
      this.isLoading = false;
      console.info(`[RecipeDetailPage] recipe detail loaded, now loading interactions and comments`);
      
      // å¼‚æ­¥åŠ è½½äº¤äº’çŠ¶æ€ã€è¯„è®ºå’ŒAIåˆ†æ
      setTimeout(() => {
        if (this.isLoggedIn) {
          this.loadInteractionStatus();
        }
        this.loadComments();
        this.loadAIAnalysisData();
      }, 100);
      
    } catch (error) {
      console.error('[RecipeDetailPage] åŠ è½½é…æ–¹è¯¦æƒ…å¤±è´¥:', error);
      this.errorMessage = 'åŠ è½½å¤±è´¥,è¯·ç¨åé‡è¯•';
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½äº¤äº’çŠ¶æ€ (ä»…ç™»å½•ç”¨æˆ·)
   * å¯¹åº” server.js: GET /api/recipes/:id/interactions
   * è¿”å›: { likeCount, favoriteCount, isLiked, isFavorited }
   */
  private async loadInteractionStatus() {
    if (!this.isLoggedIn || !this.recipeId) {
      return;
    }

    this.isLoadingInteraction = true;
    
    try {
      const response: object = await APIService.getInstance().fetchRecipeInteractionStatus(this.recipeId);
      
      const likeCountValue = Reflect.get(response, 'likeCount') as string | number | object | null;
      const favoriteCountValue = Reflect.get(response, 'favoriteCount') as string | number | object | null;
      const isLikedValue = Reflect.get(response, 'isLiked') as boolean | string | number | null;
      const isFavoritedValue = Reflect.get(response, 'isFavorited') as boolean | string | number | null;
      
      this.likeCount = this.parseNumber(likeCountValue);
      this.favoriteCount = this.parseNumber(favoriteCountValue);
      this.isLiked = Boolean(isLikedValue);
      this.isFavorited = Boolean(isFavoritedValue);
      
      console.info(`[RecipeDetailPage] äº¤äº’çŠ¶æ€åŠ è½½æˆåŠŸ - like: ${this.isLiked}, favorite: ${this.isFavorited}`);
    } catch (error) {
      console.error('[RecipeDetailPage] åŠ è½½äº¤äº’çŠ¶æ€å¤±è´¥:', error);
    } finally {
      this.isLoadingInteraction = false;
    }
  }

  /**
   * åŠ è½½AIåˆ†ææ•°æ®
   */
  private async loadAIAnalysisData() {
    if (!this.recipeId) return;
    
    try {
      const response = await APIService.getInstance().fetchRecipeRatings(this.recipeId);
      if (response.aiAnalysis) {
        this.aiAnalysisText = response.aiAnalysis;
        console.info('[RecipeDetailPage] AIåˆ†ææ•°æ®åŠ è½½æˆåŠŸ');
      }
    } catch (error) {
      console.error('[RecipeDetailPage] åŠ è½½AIåˆ†ææ•°æ®å¤±è´¥:', error);
    }
  }

  /**
   * æ‰§è¡ŒAIå£å‘³åˆ†æ
   */
  private async performAIAnalysis() {
    if (!this.recipeId) return;
    
    this.isAnalyzing = true;
    try {
      const response = await APIService.getInstance().analyzeRecipeFlavor(this.recipeId);
      this.aiAnalysisText = response.analysis;
      this.showAIAnalysis = true;
      promptAction.showToast({ message: 'AIåˆ†æå®Œæˆ' });
    } catch (error) {
      console.error('[RecipeDetailPage] AIåˆ†æå¤±è´¥:', error);
      const message = error instanceof Error ? error.message : 'AIåˆ†æå¤±è´¥';
      promptAction.showToast({ message: message });
    } finally {
      this.isAnalyzing = false;
    }
  }

  /**
   * åŠ è½½è¯„è®ºåˆ—è¡¨
   * å¯¹åº” server.js: GET /api/recipes/:id/comments
   * è¿”å›: Array<{ id, user_id, username, text, timestamp }>
   */
  private async loadComments() {
    console.info(`[RecipeDetailPage] loadComments start - recipeId: ${this.recipeId}`);
    this.isLoadingComments = true;
    this.commentError = '';
    
    try {
      const result: Array<object> = await APIService.getInstance().fetchComments(this.recipeId);
      if (Array.isArray(result)) {
        this.comments = result.map((comment: object): Comment => {
          const commentItem: Comment = {
            id: Reflect.get(comment, 'id') as string,
            user_id: Reflect.get(comment, 'user_id') as string,
            username: Reflect.get(comment, 'username') as string,
            text: Reflect.get(comment, 'text') as string,
            timestamp: this.formatTimestamp(Reflect.get(comment, 'timestamp') as string)
          };
          return commentItem;
        });
        console.info(`[RecipeDetailPage] loaded ${this.comments.length} comments`);
      }
    } catch (error) {
      console.error('[RecipeDetailPage] åŠ è½½è¯„è®ºå¤±è´¥:', error);
      this.commentError = 'åŠ è½½è¯„è®ºå¤±è´¥';
    } finally {
      this.isLoadingComments = false;
    }
  }

  /**
   * æäº¤è¯„è®º
   * å¯¹åº” server.js: POST /api/recipes/:id/comments
   * è¯·æ±‚: { commentText: string }
   * è¿”å›: æ–°è¯„è®ºå¯¹è±¡
   */
  private async submitComment() {
    // éªŒè¯è¯„è®ºå†…å®¹
    if (!this.newCommentText || this.newCommentText.trim().length === 0) {
      this.commentError = 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º';
      return;
    }
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!this.isLoggedIn) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º' });
      return;
    }
    
    this.isSubmittingComment = true;
    this.commentError = '';
    
    try {
      const newComment: object = await APIService.getInstance().addComment(
        this.recipeId, 
        this.newCommentText.trim()
      );
      
      // æ·»åŠ æ–°è¯„è®ºåˆ°åˆ—è¡¨å¤´éƒ¨
      const comment: Comment = {
        id: Reflect.get(newComment, 'id') as string,
        user_id: Reflect.get(newComment, 'user_id') as string,
        username: Reflect.get(newComment, 'username') as string,
        text: Reflect.get(newComment, 'text') as string,
        timestamp: this.formatTimestamp(Reflect.get(newComment, 'timestamp') as string)
      };
      this.comments.unshift(comment);
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      this.newCommentText = '';
      
      promptAction.showToast({ message: 'è¯„è®ºå‘è¡¨æˆåŠŸ' });
      console.info('[RecipeDetailPage] è¯„è®ºæäº¤æˆåŠŸ');
    } catch (error) {
      console.error('[RecipeDetailPage] æäº¤è¯„è®ºå¤±è´¥:', error);
      this.commentError = 'æäº¤è¯„è®ºå¤±è´¥,è¯·ç¨åé‡è¯•';
      promptAction.showToast({ message: 'æäº¤è¯„è®ºå¤±è´¥' });
    } finally {
      this.isSubmittingComment = false;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æˆ³
   */
  private formatTimestamp(timestamp: string): string {
    try {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      
      // å°äº1åˆ†é’Ÿ
      if (diff < 60000) {
        return 'åˆšåˆš';
      }
      
      // å°äº1å°æ—¶
      if (diff < 3600000) {
        const minutes = Math.floor(diff / 60000);
        return `${minutes}åˆ†é’Ÿå‰`;
      }
      
      // å°äº1å¤©
      if (diff < 86400000) {
        const hours = Math.floor(diff / 3600000);
        return `${hours}å°æ—¶å‰`;
      }
      
      // å°äº7å¤©
      if (diff < 604800000) {
        const days = Math.floor(diff / 86400000);
        return `${days}å¤©å‰`;
      }
      
      // è¿”å›å®Œæ•´æ—¥æœŸ
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hour = date.getHours().toString().padStart(2, '0');
      const minute = date.getMinutes().toString().padStart(2, '0');
      
      return `${year}-${month}-${day} ${hour}:${minute}`;
    } catch (error) {
      return timestamp;
    }
  }

  /**
   * åˆ‡æ¢ç‚¹èµçŠ¶æ€
   * å¯¹åº” server.js: POST /api/recipes/:id/like
   * è¿”å›: { success, isLiked, likeCount, favoriteCount }
   */
  private async toggleLike() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!this.isLoggedIn) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åå†ç‚¹èµ' });
      return;
    }
    
    // ä¿å­˜åŸå§‹çŠ¶æ€ä»¥ä¾¿å›æ»š
    const originalLikeCount: number = this.likeCount;
    const originalIsLiked: boolean = this.isLiked;
    
    // ä¹è§‚æ›´æ–°UI
    if (this.isLiked) {
      this.likeCount = Math.max(0, this.likeCount - 1);
      this.isLiked = false;
    } else {
      this.likeCount += 1;
      this.isLiked = true;
    }
    
    try {
      const response: object = await APIService.getInstance().toggleLike(this.recipeId);
      
      // ä»æœåŠ¡å™¨å“åº”æ›´æ–°çŠ¶æ€
      const success = Reflect.get(response, 'success') as boolean;
      if (success) {
        const isLikedValue = Reflect.get(response, 'isLiked') as boolean | string | number | null;
        const likeCountValue = Reflect.get(response, 'likeCount') as string | number | object | null;
        const favoriteCountValue = Reflect.get(response, 'favoriteCount') as string | number | object | null;
        
        this.isLiked = Boolean(isLikedValue);
        this.likeCount = this.parseNumber(likeCountValue);
        
        // åŒæ—¶æ›´æ–°æ”¶è—æ•°(æœåŠ¡å™¨ä¸€å¹¶è¿”å›)
        if (favoriteCountValue !== undefined && favoriteCountValue !== null) {
          this.favoriteCount = this.parseNumber(favoriteCountValue);
        }
      }
      
      console.info(`[RecipeDetailPage] ç‚¹èµæˆåŠŸ id=${this.recipeId}, isLiked=${this.isLiked}`);
    } catch (error) {
      console.error('[RecipeDetailPage] ç‚¹èµå¤±è´¥:', error);
      // å›æ»šçŠ¶æ€
      this.likeCount = originalLikeCount;
      this.isLiked = originalIsLiked;
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥,è¯·ç¨åé‡è¯•' });
    }
  }

  /**
   * åˆ‡æ¢æ”¶è—çŠ¶æ€
   * å¯¹åº” server.js: POST /api/recipes/:id/favorite
   * è¿”å›: { success, isFavorited, likeCount, favoriteCount }
   */
  private async toggleFavorite() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!this.isLoggedIn) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åå†æ”¶è—' });
      return;
    }
    
    // ä¿å­˜åŸå§‹çŠ¶æ€ä»¥ä¾¿å›æ»š
    const originalFavoriteCount: number = this.favoriteCount;
    const originalIsFavorited: boolean = this.isFavorited;
    
    // ä¹è§‚æ›´æ–°UI
    if (this.isFavorited) {
      this.favoriteCount = Math.max(0, this.favoriteCount - 1);
      this.isFavorited = false;
    } else {
      this.favoriteCount += 1;
      this.isFavorited = true;
    }
    
    try {
      const response: object = await APIService.getInstance().toggleFavorite(this.recipeId);
      
      // ä»æœåŠ¡å™¨å“åº”æ›´æ–°çŠ¶æ€
      const success = Reflect.get(response, 'success') as boolean;
      if (success) {
        const isFavoritedValue = Reflect.get(response, 'isFavorited') as boolean | string | number | null;
        const favoriteCountValue = Reflect.get(response, 'favoriteCount') as string | number | object | null;
        const likeCountValue = Reflect.get(response, 'likeCount') as string | number | object | null;
        
        this.isFavorited = Boolean(isFavoritedValue);
        this.favoriteCount = this.parseNumber(favoriteCountValue);
        
        // åŒæ—¶æ›´æ–°ç‚¹èµæ•°(æœåŠ¡å™¨ä¸€å¹¶è¿”å›)
        if (likeCountValue !== undefined && likeCountValue !== null) {
          this.likeCount = this.parseNumber(likeCountValue);
        }
      }
      
      console.info(`[RecipeDetailPage] æ”¶è—æˆåŠŸ id=${this.recipeId}, isFavorited=${this.isFavorited}`);
    } catch (error) {
      console.error('[RecipeDetailPage] æ”¶è—å¤±è´¥:', error);
      // å›æ»šçŠ¶æ€
      this.favoriteCount = originalFavoriteCount;
      this.isFavorited = originalIsFavorited;
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥,è¯·ç¨åé‡è¯•' });
    }
  }

  /**
   * è®¡ç®—æ€»å®¹é‡
   */
  private calculateTotalVolume(): number {
    let total = 0;
    for (let i = 0; i < this.ingredients.length; i++) {
      const ing: Ingredient = this.ingredients[i];
      if (ing.volume) {
        total += ing.volume;
      }
    }
    return total;
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) { // âœ… ä½¿ç”¨ Stack ç¡®ä¿è¾“å…¥æ¡†å¸åº•
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.buildTopBar()
        
        if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        Column() {
          Text('âš ï¸')
            .fontSize(64)
            .opacity(0.3)
          
          Text(this.errorMessage)
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 16 })
            .textAlign(TextAlign.Center)
            .padding({ left: 32, right: 32 })
          
          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .margin({ top: 20 })
            .onClick(() => {
              this.loadRecipeDetail();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.recipe) {
        // å†…å®¹å±•ç¤º
        Scroll() {
          Column({ space: 16 }) {
            // æ ‡é¢˜å’Œä½œè€…ä¿¡æ¯
            this.buildHeaderSection()
            
            // æ“ä½œæŒ‰é’®è¡Œ
            this.buildActionButtons()
            
            // é…æ–™æ¸…å•
            this.buildIngredientsSection()
            
            // è°ƒåˆ¶è¯´æ˜
            this.buildInstructionsSection()
            
            // è¥å…»ä¿¡æ¯
            this.buildNutritionSection()
            
            // AIå£å‘³åˆ†æåŒºåŸŸ
            this.buildAIAnalysisSection()
            
            // è¯„è®ºåŒºåŸŸ
            this.buildCommentsSection()

            // âœ… åº•éƒ¨ç•™å‡ºä¸€ä¸ªè¾“å…¥æ¡†çš„é«˜åº¦ï¼Œé˜²æ­¢è¢«é®æŒ¡
            Blank().height(100)
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 0, bottom: 16 })
        }
        .width('100%')
        .layoutWeight(1) // å æ»¡å‰©ä½™ç©ºé—´
        .scrollBar(BarState.Off) // å…³é—­æ»šåŠ¨æ¡å‡å°‘å¸ƒå±€å¹²æ‰°
        .edgeEffect(EdgeEffect.None) // å¦‚æœé—ªé€€ä¾ç„¶å­˜åœ¨ï¼Œå°è¯•å…³é—­è¾¹ç¼˜å›å¼¹
      }
    }
    .width('100%')
    .height('100%')

    // âœ… æ–°å¢ï¼šå¸åº•è¯„è®ºæ ï¼Œåªè¦ç™»å½•äº†å°±æ°¸è¿œæ˜¾ç¤ºåœ¨æœ€ä¸‹é¢
    // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šå¸åº•è¯„è®ºæ 
    // åªè¦åŠ è½½å®Œæˆä¸”å·²ç™»å½•ï¼Œè¾“å…¥æ¡†å°±æ°¸è¿œå›ºå®šåœ¨å±å¹•æœ€ä¸‹æ–¹
    if (!this.isLoading && this.recipe && this.isLoggedIn) {
      Row({ space: 12 }) {
        TextInput({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: $$this.newCommentText })
          .layoutWeight(1)
          .height(42)
          .backgroundColor('#F5F5F5')
          .borderRadius(21)
          .enterKeyType(EnterKeyType.Send)
          .onSubmit(() => this.submitComment())

        Button(this.isSubmittingComment ? '...' : 'å‘é€')
          .type(ButtonType.Capsule)
          .height(36)
          .backgroundColor('#1890ff')
          .enabled(!this.isSubmittingComment && this.newCommentText.trim().length > 0)
          .onClick(() => this.submitComment())
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 10, bottom: 30 }) // é€‚é…æ‰‹åŠ¿åŒº
      .backgroundColor(Color.White)
      .shadow({ radius: 10, color: '#10000000', offsetY: -2 })
    }
  }
  .width('100%')
  .height('100%')
  .backgroundColor('#F5F5F5')
  .bindSheet($$this.showComments, this.buildCommentsSheet(), {
      height: SheetSize.LARGE,
      // showClose: false,
      dragBar: true,
      backgroundColor: Color.White,
      onDisappear: () => {
        this.showComments = false;
      }
    })
    .bindSheet($$this.showAIAnalysis, this.buildAIAnalysisSheet(), {
      height: SheetSize.LARGE,
      // showClose: false,
      dragBar: true,
      backgroundColor: Color.White,
      onDisappear: () => {
        this.showAIAnalysis = false;
      }
    })
  }

  /**
   * æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
   */
  @Builder
  buildTopBar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button() {
        Row({ space: 4 }) {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
          Text('è¿”å›')
            .fontSize(16)
            .fontColor('#333333')
        }
      }
      .type(ButtonType.Normal)
      .backgroundColor(Color.Transparent)
      .height(44)
      .padding({ left: 4, right: 12 })
      .onClick(() => {
        this.goBack();
      })
      
      Blank()
      
      Text('é…æ–¹è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
      
      Blank()
      
      // å ä½,ä¿æŒæ ‡é¢˜å±…ä¸­
      Row()
        .width(80)
        .height(44)
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 16 })
    .backgroundColor(Color.White)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * æ„å»ºæ ‡é¢˜åŒºåŸŸ
   */
  @Builder
  buildHeaderSection() {

    if (this.recipe) {
      Column({ space: 0 }) {

        // 1. é¡¶éƒ¨å¤§å›¾åŒºåŸŸ
        Image(APIService.getInstance().getFullImageUrl(this.recipe?.image || this.DEFAULT_WINE_IMAGE))
          .width('100%')
          .height(300)
          .objectFit(ImageFit.Cover)
          .backgroundColor('#E0E0E0')

        // 2. ä¿¡æ¯å¡ç‰‡åŒºåŸŸ (é€šè¿‡è´Ÿ margin å®ç°å‘ä¸Šåç§»ï¼Œç›–åœ¨å›¾ç‰‡åº•éƒ¨)
        Column({ space: 12 }) {
          // æ ‡é¢˜
          Text(this.recipe?.name ?? 'åŠ è½½ä¸­...')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .width('100%')
            .lineHeight(38)

          // ä½œè€…ä¸ ABV ä¿¡æ¯
          Row({ space: 12 }) {
            Text(`ğŸ‘¤ ${this.recipe?.createdBy ?? 'æœªçŸ¥ä½œè€…'}`)
              .fontSize(15)
              .fontColor('#666666')

            Text('|')
              .fontSize(15)
              .fontColor('#DDDDDD')

            Text(`${(this.recipe?.estimatedAbv ?? 0).toFixed(1)}% ABV`)
              .fontSize(15)
              .fontColor('#1890ff')
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')

          // é£å‘³æè¿°ä¸“åŒº (description)
          if (this.recipe?.description) {
            Text(this.recipe.description)
              .fontSize(16)
              .fontColor('#555555')
              .lineHeight(24)
              .width('100%')
              .margin({ top: 8 })
              .padding(12)
              .backgroundColor('#F9F9F9') // æµ…ç°èƒŒæ™¯è¡¬æ‰˜æè¿°å†…å®¹
              .borderRadius(8)
          }
        }
        .width('92%') // å¡ç‰‡å®½åº¦ç•¥çª„äºå±å¹•ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .shadow({ radius: 10, color: '#10000000', offsetY: 4 })
        .margin({ top: -30 }) // âœ… å…³é”®ï¼šä½¿ç”¨è´Ÿè¾¹è·è®©å¡ç‰‡å‘ä¸Šç§»åŠ¨ï¼Œç›–ä½å›¾ç‰‡åº•éƒ¨
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center) // è®©å†…éƒ¨çš„å¡ç‰‡å±…ä¸­
    }
  }

  /**
   * æ„å»ºæ“ä½œæŒ‰é’®
   */
  @Builder
  buildActionButtons() {
    Row({ space: 12 }) {
      // ç‚¹èµæŒ‰é’®
      Button() {
        Row({ space: 8 }) {
          Text(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
            .fontSize(20)
          Text(`${this.likeCount}`)
            .fontSize(14)
            .fontColor(this.isLiked ? '#FF4D4F' : '#666666')
            .fontWeight(FontWeight.Medium)
        }
      }
      .type(ButtonType.Normal)
      .backgroundColor(this.isLiked ? '#FFE4E6' : '#F5F5F5')
      .borderRadius(20)
      .height(44)
      .layoutWeight(1)
      .onClick(() => {
        this.toggleLike();
      })

      // æ”¶è—æŒ‰é’®
      Button() {
        Row({ space: 8 }) {
          Text(this.isFavorited ? 'â­' : 'â˜†')
            .fontSize(20)
            .fontColor(this.isFavorited ? '#FFD700' : '#999999')
          Text(`${this.favoriteCount}`)
            .fontSize(14)
            .fontColor(this.isFavorited ? '#FFA500' : '#666666')
            .fontWeight(FontWeight.Medium)
        }
      }
      .type(ButtonType.Normal)
      .backgroundColor(this.isFavorited ? '#FFF8DC' : '#F5F5F5')
      .borderRadius(20)
      .height(44)
      .layoutWeight(1)
      .onClick(() => {
        this.toggleFavorite();
      })

      // è¯„è®ºæŒ‰é’®
      Button() {
        Row({ space: 8 }) {
          Text('ğŸ’¬')
            .fontSize(20)
          Text(`${this.comments.length}`)
            .fontSize(14)
            .fontColor('#666666')
            .fontWeight(FontWeight.Medium)
        }
      }
      .type(ButtonType.Normal)
      .backgroundColor('#F5F5F5')
      .borderRadius(20)
      .height(44)
      .layoutWeight(1)
      .onClick(() => {
        this.showComments = true;
      })
    }
    .width('100%')
  }

  /**
   * æ„å»ºé…æ–™æ¸…å•
   */
  @Builder
  buildIngredientsSection() {
    if (this.ingredients.length > 0) {
      Column({ space: 14 }) {
        Text('ğŸ§ª é…æ–™æ¸…å•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .width('100%')
        
        Column({ space: 0 }) {
          ForEach(this.ingredients, (ingredient: Ingredient, index: number) => {
            Column() {
              Row() {
                Column({ space: 4 }) {
                  Text(ingredient.name)
                    .fontSize(16)
                    .fontColor('#333333')
                    .fontWeight(FontWeight.Medium)
                  
                  if (ingredient.abv && ingredient.abv > 0) {
                    Text(`${ingredient.abv.toFixed(1)}% ABV`)
                      .fontSize(13)
                      .fontColor('#999999')
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                
                Text(`${ingredient.volume.toFixed(0)} ml`)
                  .fontSize(16)
                  .fontColor('#1890ff')
                  .fontWeight(FontWeight.Bold)
              }
              .width('100%')
              .padding(16)
              
              if (index < this.ingredients.length - 1) {
                Divider()
                  .color('#F0F0F0')
              }
            }
          }, (ingredient: Ingredient, index: number) => `${this.recipeId}_ing_${index}`)
        }
        .width('100%')
        .backgroundColor('#FAFAFA')
        .borderRadius(12)
        
        // æ€»è®¡
        Row() {
          Text('æ€»å®¹é‡')
            .fontSize(15)
            .fontColor('#666666')
          
          Blank()
          
          Text(`${this.calculateTotalVolume().toFixed(0)} ml`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890ff')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#E6F7FF')
        .borderRadius(12)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
  }

  /**
   * æ„å»ºè°ƒåˆ¶è¯´æ˜
   */
  @Builder
  buildInstructionsSection() {
    if (this.recipe && this.recipe.instructions && this.recipe.instructions.length > 0) {
      Column({ space: 14 }) {
        Text('ğŸ“ è°ƒåˆ¶æ­¥éª¤')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .width('100%')
        
        Text(this.recipe.instructions)
          .fontSize(15)
          .fontColor('#555555')
          .lineHeight(26)
          .width('100%')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .alignItems(HorizontalAlign.Start)
    }
  }

  /**
   * æ„å»ºè¥å…»ä¿¡æ¯
   */
  @Builder
  buildNutritionSection() {
    if (this.recipe) {
      Column({ space: 14 }) {
      Text('ğŸ“Š è¥å…»ä¿¡æ¯')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
        .width('100%')
      
      Row({ space: 16 }) {
        Column({ space: 8 }) {
          Text('é…’ç²¾åº¦')
            .fontSize(13)
            .fontColor('#999999')
          Text(`${this.recipe.estimatedAbv.toFixed(1)}%`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890ff')
        }
        .layoutWeight(1)
        .padding(16)
        .backgroundColor('#E6F7FF')
        .borderRadius(12)
        
        Column({ space: 8 }) {
          Text('æ€»å®¹é‡')
            .fontSize(13)
            .fontColor('#999999')
          Text(`${this.calculateTotalVolume().toFixed(0)} ml`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#52C41A')
        }
        .layoutWeight(1)
        .padding(16)
        .backgroundColor('#F6FFED')
        .borderRadius(12)
        }
        .width('100%')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
  }

  /**
   * æ„å»ºè¯„è®ºé¢„è§ˆåŒºåŸŸ
   */
  @Builder
  buildCommentsSection() {
    Column({ space: 14 }) {
      Row() {
        Text(`ğŸ’¬ è¯„è®º (${this.comments.length})`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
        
        Blank()
        
        if (this.comments.length > 0) {
          Button('æŸ¥çœ‹å…¨éƒ¨')
            .fontSize(14)
            .type(ButtonType.Normal)
            .backgroundColor('#F0F0F0')
            .borderRadius(16)
            .height(32)
            .onClick(() => {
              this.showComments = true;
            })
        }
      }
      .width('100%')
      
      if (this.isLoadingComments) {
        Row() {
          LoadingProgress()
            .width(30)
            .height(30)
          Text('åŠ è½½è¯„è®ºä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ left: 10 })
        }
        .width('100%')
        .height(60)
        .justifyContent(FlexAlign.Center)
      } else if (this.commentError) {
        Column({ space: 8 }) {
          Text('âš ï¸')
            .fontSize(32)
            .opacity(0.5)
          Text(this.commentError)
            .fontSize(14)
            .fontColor('#FF3B30')
          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .height(32)
            .onClick(() => {
              this.loadComments();
            })
        }
        .width('100%')
        .padding(24)
        .justifyContent(FlexAlign.Center)
      } else if (this.comments.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸ“')
            .fontSize(48)
            .opacity(0.3)
          Text('æš‚æ— è¯„è®º')
            .fontSize(16)
            .fontColor('#666666')
            .fontWeight(FontWeight.Medium)
          Text(this.isLoggedIn ? 'å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§!' : 'ç™»å½•åå¯ä»¥å‘è¡¨è¯„è®º')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(32)
        .justifyContent(FlexAlign.Center)
      } else {
        // æ˜¾ç¤ºå‰3æ¡è¯„è®º
        Column({ space: 12 }) {
          ForEach(this.comments.slice(0, 3), (comment: Comment) => {
            Column({ space: 8 }) {
              Row({ space: 8 }) {
                Text(comment.username)
                  .fontSize(14)
                  .fontColor('#333333')
                  .fontWeight(FontWeight.Medium)
                
                Blank()
                
                Text(comment.timestamp)
                  .fontSize(12)
                  .fontColor('#999999')
              }
              .width('100%')
              
              Text(comment.text)
                .fontSize(14)
                .fontColor('#666666')
                .lineHeight(22)
                .width('100%')
                .maxLines(3)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#FAFAFA')
            .borderRadius(8)
          }, (comment: Comment) => comment.id)
          
          // å¦‚æœè¯„è®ºè¶…è¿‡3æ¡,æ˜¾ç¤ºæç¤º
          if (this.comments.length > 3) {
            Text(`è¿˜æœ‰ ${this.comments.length - 3} æ¡è¯„è®º`)
              .fontSize(13)
              .fontColor('#007DFF')
              .textAlign(TextAlign.Center)
              .width('100%')
              .padding({ top: 4, bottom: 4 })
              .onClick(() => {
                this.showComments = true;
              })
          }
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  /**
   * æ„å»ºè¯„è®ºåŠæ¨¡æ€
   */
  @Builder
  buildCommentsSheet() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(`è¯„è®º (${this.comments.length})`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Button() {
          Text('âœ•')
            .fontSize(22)
            .fontColor('#666666')
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(40)
        .height(40)
        .onClick(() => {
          this.showComments = false;
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 8 })
      .borderRadius({ topLeft: 16, topRight: 16 })
      
      Divider()
      
      // è¯„è®ºåˆ—è¡¨
      if (this.isLoadingComments) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½è¯„è®ºä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.comments.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸ“')
            .fontSize(64)
            .opacity(0.3)
          Text('æš‚æ— è¯„è®º')
            .fontSize(16)
            .fontColor('#666666')
            .fontWeight(FontWeight.Medium)
          Text(this.isLoggedIn ? 'å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§!' : 'ç™»å½•åå¯ä»¥å‘è¡¨è¯„è®º')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        List({ space: 12 }) {
          ForEach(this.comments, (comment: Comment, index: number) => {
            ListItem() {
              Column({ space: 8 }) {
                Row({ space: 8 }) {
                  // ç”¨æˆ·å¤´åƒå ä½ç¬¦
                  Text(comment.username.substring(0, 1).toUpperCase())
                    .fontSize(16)
                    .fontColor('#FFFFFF')
                    .fontWeight(FontWeight.Bold)
                    .width(36)
                    .height(36)
                    .textAlign(TextAlign.Center)
                    .backgroundColor('#1890ff')
                    .borderRadius(18)
                  
                  Column({ space: 4 }) {
                    Text(comment.username)
                      .fontSize(15)
                      .fontColor('#333333')
                      .fontWeight(FontWeight.Medium)
                    
                    Text(comment.timestamp)
                      .fontSize(12)
                      .fontColor('#999999')
                  }
                  .alignItems(HorizontalAlign.Start)
                  
                  Blank()
                  
                  // æ¥¼å±‚å·
                  Text(`#${this.comments.length - index}`)
                    .fontSize(12)
                    .fontColor('#999999')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .backgroundColor('#F5F5F5')
                    .borderRadius(4)
                }
                .width('100%')
                
                Text(comment.text)
                  .fontSize(14)
                  .fontColor('#666666')
                  .lineHeight(22)
                  .width('100%')
                  .margin({ left: 44 })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#F9F9F9')
              .borderRadius(12)
            }
          }, (comment: Comment) => comment.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .scrollBar(BarState.Auto)
      }
      
      Divider()
      
      // è¯„è®ºè¾“å…¥åŒº
      if (this.isLoggedIn) {
        Column({ space: 8 }) {
          // é”™è¯¯æç¤º
          if (this.commentError) {
            Row({ space: 8 }) {
              Text('âš ï¸')
                .fontSize(14)
              Text(this.commentError)
                .fontSize(13)
                .fontColor('#FF3B30')
            }
            .width('100%')
            .padding({ left: 4, right: 4 })
          }
          
          // è¾“å…¥æ¡†
          Row({ space: 12 }) {
            TextInput({ placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...', text: $$this.newCommentText })
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#F5F5F5')
              .borderRadius(22)
              .padding({ left: 16, right: 16 })
              .maxLength(500)
            
            Button(this.isSubmittingComment ? 'å‘é€ä¸­' : 'å‘é€')
              .type(ButtonType.Normal)
              .backgroundColor(this.isSubmittingComment || this.newCommentText.trim().length === 0 ? '#CCCCCC' : '#1890ff')
              .fontColor(Color.White)
              .height(44)
              .borderRadius(22)
              .padding({ left: 20, right: 20 })
              .enabled(!this.isSubmittingComment && this.newCommentText.trim().length > 0)
              .onClick(() => {
                this.submitComment();
              })
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
      } else {
        // æœªç™»å½•æç¤º
        Row({ space: 12 }) {
          Text('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º')
            .fontSize(14)
            .fontColor('#666666')
            .layoutWeight(1)
          
          Button('å»ç™»å½•')
            .type(ButtonType.Normal)
            .backgroundColor('#1890ff')
            .fontColor(Color.White)
            .height(36)
            .onClick(() => {
              this.showComments = false;
              // TODO: è·³è½¬åˆ°ç™»å½•é¡µé¢
              promptAction.showToast({ message: 'è¯·å‰å¾€ç™»å½•é¡µé¢' });
            })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFAF0')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  /**
   * æ„å»ºAIå£å‘³åˆ†æåŒºåŸŸ
   */
  @Builder
  buildAIAnalysisSection() {
    Column({ space: 16 }) {
      // æ ‡é¢˜è¡Œ
      Row() {
        Text('ğŸ¤– AIå£å‘³åˆ†æ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
        
        Blank()
        
        // æ˜¾ç¤ºåˆ†æçŠ¶æ€
        if (this.aiAnalysisText) {
          Text('âœ… å·²åˆ†æ')
            .fontSize(12)
            .fontColor('#52c41a')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#f6ffed')
            .borderRadius(4)
        }
      }
      .width('100%')
      
      // æ“ä½œæŒ‰é’®
      if (!this.aiAnalysisText) {
        // æœªåˆ†æï¼šæ˜¾ç¤ºAIåˆ†ææŒ‰é’®
        Button() {
          Row({ space: 8 }) {
            if (this.isAnalyzing) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color(Color.White)
            } else {
              Text('ğŸ¤–')
                .fontSize(16)
            }
            Text(this.isAnalyzing ? 'åˆ†æä¸­...' : 'AIæ™ºèƒ½åˆ†æ')
              .fontSize(14)
              .fontColor(Color.White)
          }
        }
        .type(ButtonType.Normal)
        .width('100%')
        .height(44)
        .borderRadius(22)
        .linearGradient({
          direction: GradientDirection.Right,
          colors: [['#667eea', 0], ['#764ba2', 1]]
        })
        .enabled(!this.isAnalyzing)
        .onClick(() => {
          this.performAIAnalysis();
        })
      } else {
        // å·²åˆ†æï¼šæ˜¾ç¤ºæŸ¥çœ‹åˆ†ææŒ‰é’®å’Œé‡æ–°åˆ†ææŒ‰é’®
        Row({ space: 12 }) {
          Button() {
            Row({ space: 8 }) {
              Text('ğŸ“Š')
                .fontSize(16)
              Text('æŸ¥çœ‹AIåˆ†æ')
                .fontSize(14)
                .fontColor(Color.White)
            }
          }
          .type(ButtonType.Normal)
          .layoutWeight(1)
          .height(44)
          .borderRadius(22)
          .linearGradient({
            direction: GradientDirection.Right,
            colors: [['#11998e', 0], ['#38ef7d', 1]]
          })
          .onClick(() => {
            this.showAIAnalysis = true;
          })
          
          Button() {
            Row({ space: 8 }) {
              if (this.isAnalyzing) {
                LoadingProgress()
                  .width(16)
                  .height(16)
                  .color('#666666')
              } else {
                Text('ğŸ”„')
                  .fontSize(14)
              }
              Text(this.isAnalyzing ? 'åˆ†æä¸­' : 'é‡æ–°åˆ†æ')
                .fontSize(14)
                .fontColor('#666666')
            }
          }
          .type(ButtonType.Normal)
          .layoutWeight(1)
          .height(44)
          .borderRadius(22)
          .backgroundColor('#F5F5F5')
          .enabled(!this.isAnalyzing)
          .onClick(() => {
            this.performAIAnalysis();
          })
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  /**
   * ä»AIåˆ†ææ–‡æœ¬ä¸­æå–è¯„åˆ†
   */
  private parseScoreFromText(text: string, label: string, maxScore: number): number {
    // åŒ¹é… "æ ‡ç­¾: X/Y" æˆ– "æ ‡ç­¾ï¼šX/Y" æ ¼å¼
    const patterns = [
      new RegExp(`${label}[ï¼š:][\\s]*(\\d+(?:\\.\\d+)?)[/ï¼](\\d+)`, 'i'),
      new RegExp(`${label}[ï¼š:].*?(\\d+(?:\\.\\d+)?)[/ï¼](\\d+)`, 'i')
    ];
    
    for (const pattern of patterns) {
      const match = text.match(pattern);
      if (match) {
        const score = parseFloat(match[1]);
        return Math.min(score, maxScore);
      }
    }
    return 0;
  }

  /**
   * æ„å»ºè¯„åˆ†è¿›åº¦æ¡
   */
  @Builder
  buildScoreBar(label: string, score: number, maxScore: number, color: string, icon: string) {
    Column({ space: 8 }) {
      Row() {
        Text(icon)
          .fontSize(16)
        Text(label)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .margin({ left: 6 })
        
        Blank()
        
        Text(`${score}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(color)
        Text(`/${maxScore}`)
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      
      Stack({ alignContent: Alignment.Start }) {
        // èƒŒæ™¯æ¡
        Row()
          .width('100%')
          .height(12)
          .backgroundColor('#F0F0F0')
          .borderRadius(6)
        
        // è¿›åº¦æ¡ - æ¸å˜æ•ˆæœ
        Row()
          .width(`${(score / maxScore) * 100}%`)
          .height(12)
          .linearGradient({
            direction: GradientDirection.Right,
            colors: [[color, 0], [this.lightenColor(color), 1]]
          })
          .borderRadius(6)
          .shadow({
            radius: 4,
            color: color,
            offsetX: 0,
            offsetY: 2
          })
      }
      .width('100%')
    }
    .width('100%')
  }

  /**
   * å°†é¢œè‰²å˜äº®
   */
  private lightenColor(hex: string): string {
    // ç®€å•å¤„ç†ï¼šåœ¨é¢œè‰²ååŠ é€æ˜åº¦æˆ–è¿”å›è¾ƒäº®ç‰ˆæœ¬
    const colorMap: Record<string, string> = {
      '#FF6B6B': '#FF9999',
      '#4ECDC4': '#7EEEE6',
      '#45B7D1': '#7DD3E8',
      '#96CEB4': '#B8E4D0',
      '#DDA0DD': '#EECCEE',
      '#FFB347': '#FFCC80',
      '#87CEEB': '#B0E0F0',
      '#98D8C8': '#C0EAE0',
      '#F7DC6F': '#FCE99A',
      '#BB8FCE': '#D4B8E0'
    };
    return colorMap[hex] || hex;
  }

  /**
   * æ„å»ºAIåˆ†æç»“æœé¢æ¿
   */
  @Builder
  buildAIAnalysisSheet() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('å…³é—­')
          .fontSize(16)
          .fontColor('#007DFF')
          .onClick(() => {
            this.showAIAnalysis = false;
          })
        
        Blank()
        
        Text('AIå£å‘³åˆ†æ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text('     ')
          .width(50)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      
      Divider()
      
      // åˆ†æå†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          // æ ‡é¢˜å¡ç‰‡
          Row({ space: 8 }) {
            Text('ğŸ¤–')
              .fontSize(24)
            Text('AIä¸“ä¸šå£å‘³åˆ†ææŠ¥å‘Š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
          }
          .width('100%')
          .padding(16)
          .linearGradient({
            direction: GradientDirection.Right,
            colors: [['#667eea', 0], ['#764ba2', 1]]
          })
          .borderRadius(12)
          
          if (this.aiAnalysisText) {
            // ç»¼åˆè¯„åˆ†å»ºè®®åŒºåŸŸ
            Column({ space: 16 }) {
              Row() {
                Text('ğŸ“Š')
                  .fontSize(18)
                Text(' ç»¼åˆè¯„åˆ†å»ºè®®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
              }
              .width('100%')
              
              Column({ space: 14 }) {
                this.buildScoreBar('å¤–è§‚å‘ˆç°', this.parseScoreFromText(this.aiAnalysisText, 'å¤–è§‚å‘ˆç°', 10), 10, '#FF6B6B', 'ğŸ¨')
                this.buildScoreBar('é¦™æ°”è¡¨ç°', this.parseScoreFromText(this.aiAnalysisText, 'é¦™æ°”è¡¨ç°', 10), 10, '#4ECDC4', 'ğŸ‘ƒ')
                this.buildScoreBar('é£å‘³å¹³è¡¡', this.parseScoreFromText(this.aiAnalysisText, 'é£å‘³å¹³è¡¡', 10), 10, '#45B7D1', 'ğŸ‘…')
                this.buildScoreBar('å£æ„Ÿä½“éªŒ', this.parseScoreFromText(this.aiAnalysisText, 'å£æ„Ÿä½“éªŒ', 10), 10, '#96CEB4', 'ğŸ’«')
                this.buildScoreBar('ä½™éŸµæŒä¹…', this.parseScoreFromText(this.aiAnalysisText, 'ä½™éŸµæŒä¹…', 10), 10, '#DDA0DD', 'âœ¨')
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FAFAFA')
            .borderRadius(16)
            
            // å£å‘³ç‰¹å¾åŒºåŸŸ
            Column({ space: 16 }) {
              Row() {
                Text('ğŸ¸')
                  .fontSize(18)
                Text(' å£å‘³ç‰¹å¾')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
              }
              .width('100%')
              
              Column({ space: 14 }) {
                this.buildScoreBar('ç”œåº¦', this.parseScoreFromText(this.aiAnalysisText, 'ç”œåº¦', 5), 5, '#FFB347', 'ğŸ¯')
                this.buildScoreBar('é…¸åº¦', this.parseScoreFromText(this.aiAnalysisText, 'é…¸åº¦', 5), 5, '#87CEEB', 'ğŸ‹')
                this.buildScoreBar('è‹¦åº¦', this.parseScoreFromText(this.aiAnalysisText, 'è‹¦åº¦', 5), 5, '#98D8C8', 'ğŸŒ¿')
                this.buildScoreBar('çƒˆåº¦', this.parseScoreFromText(this.aiAnalysisText, 'çƒˆåº¦', 5), 5, '#F7DC6F', 'ğŸ”¥')
                this.buildScoreBar('æ¸…çˆ½åº¦', this.parseScoreFromText(this.aiAnalysisText, 'æ¸…çˆ½åº¦', 5), 5, '#BB8FCE', 'â„ï¸')
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#F0F8FF')
            .borderRadius(16)
            
            // è¯¦ç»†åˆ†ææ–‡æœ¬
            Column({ space: 12 }) {
              Row() {
                Text('ğŸ“')
                  .fontSize(18)
                Text(' è¯¦ç»†åˆ†æ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
              }
              .width('100%')
              
              Text(this.aiAnalysisText)
                .fontSize(14)
                .fontColor('#555555')
                .lineHeight(24)
                .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .border({ width: 1, color: '#E8E8E8' })
            
          } else {
            Column({ space: 16 }) {
              Text('âš ï¸')
                .fontSize(48)
                .opacity(0.5)
              Text('æš‚æ— AIåˆ†æç»“æœ')
                .fontSize(16)
                .fontColor('#999999')
              
              Button('å¼€å§‹AIåˆ†æ')
                .type(ButtonType.Normal)
                .height(44)
                .borderRadius(22)
                .linearGradient({
                  direction: GradientDirection.Right,
                  colors: [['#667eea', 0], ['#764ba2', 1]]
                })
                .onClick(() => {
                  this.showAIAnalysis = false;
                  this.performAIAnalysis();
                })
            }
            .width('100%')
            .padding(40)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
